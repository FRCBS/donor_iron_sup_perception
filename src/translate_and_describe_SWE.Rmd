---
title: "Donor iron supplement perception study data description and translation - Finland"
author: "Mikko Arvas"
date: "`r Sys.time()`"
output:
  html_document:
    df_print: paged
  pdf_document: 
    fig_caption: yes
    number_sections: yes
---

\tableofcontents


```{r setup, include=FALSE}

  
library(knitr)
opts_chunk$set(#results = 'asis',      # Can also be set at the chunk-level. IT IS NEEDED IN THE dfsummary chunck
               comment = NA,
               prompt  = FALSE,
               cache   = FALSE,
               echo = TRUE,
               message = FALSE,
               warning = FALSE,
               width.cutoff=60
)
library(summarytools)
st_options(plain.ascii = FALSE,        # Always use this option in Rmd documents
           style        = "rmarkdown", # Always use this option in Rmd documents
           footnote     = NA,          # Makes html-rendered results more concise
           subtitle.emphasis = FALSE)  # Improves layout with some rmardown themes
library(tidyverse)
library(readxl)
library(lubridate)
library(summarytools)
library(haven)


```


# Read and summarise data


```{r}
# Open SPSS dataset with survey data
Data <- read_xlsx("L:/DonorMedicin/FORTE/E Internation Donor Perception Survey/A Source documents/iDPS - SWE/Blood donation survey(1-183)_translation.xlsx")
data <- Data
colnames(data)
```


# Translate questions
```{r}
# Delete unused variables
data <- data[ , !(names(data) %in% c("Start time", "Completion time", "E-mail", "Name", "Last changed time"))]


names(data) <- gsub("^How old are you\\?$", "Age", names(data))
names(data) <- gsub("^Sex\\?$", "Sex", names(data))
names(data) <- gsub("^Do you have regular periods\\?$", "Menstruation", names(data))
names(data) <- gsub("^In which municipality do you live\\?$", "Area", names(data))
names(data) <- gsub("^What is your highest completed level of education\\?$", "Education", names(data))
names(data) <- gsub("^How do you feel about your health\\?$", "Health", names(data))
names(data) <- gsub("^Do you eat a vegetarian or vegan diet\\?$", "Diet", names(data))
names(data) <- gsub("^On how many occasions have you donated blood in total\\?$", "Number_donation", names(data)) 
names(data) <- gsub("^Other than today, when was your last blood donation\\?$", "Last_donation", names(data))

names(data) <- gsub("^I experience the blood center as a professional organization$", "OpinionBloodService1", names(data))
names(data) <- gsub("^When I give blood there is sufficient opportunity to ask questions$", "OpinionBloodService2", names(data))
names(data) <- gsub("^I feel that the blood center handles my personal data in a judicious manner$", "OpinionBloodService3", names(data))
names(data) <- gsub("^Staff receive me when I arrive at the blood centre$", "OpinionBloodService4", names(data))
names(data) <- gsub("^I would be disappointed if I didn\\'t get to continue giving blood$", "OpinionBloodService5", names(data))
names(data) <- gsub("^I leave blood to check my health$", "OpinionBloodService6", names(data))
names(data) <- gsub("^I trust the competence of the blood donation staff$", "OpinionBloodService7", names(data))
names(data) <- gsub("^feel that the health of blood donors is important to the Blood Centre$", "OpinionBloodService8", names(data))

#names(data) <- gsub("^Bruising at the puncture site$", "Symptoms1", names(data)) #this question is missing
names(data) <- gsub("^Fainting$", "Symptoms2", names(data))
names(data) <- gsub("^Fatigue$", "Symptoms3", names(data))
names(data) <- gsub("^Pain in the arm$", "Symptoms4", names(data))
names(data) <- gsub("^Prolonged deterioration of well\\-being \\(days\\)$", "Symptoms5", names(data))
names(data) <- gsub("^Dizziness$", "Symptoms6", names(data))
names(data) <- gsub("^Bleeding from the injection site$", "Symptoms7", names(data))
names(data) <- gsub("^Headache$", "Symptoms8", names(data))
names(data) <- gsub("^Increased energy level after donating blood$", "Symptoms9", names(data))
names(data) <- gsub("^Thirst$", "Symptoms10", names(data))


names(data) <- gsub("^Bruising at the puncture site$", "Symptoms1_Severity", names(data))
names(data) <- gsub("^Fainting2$", "Symptoms2_Severity", names(data))
names(data) <- gsub("^Fatigue2$", "Symptoms3_Severity", names(data))
#names(data) <- gsub("^Pain in the arm2$", "Symptoms4_Severity", names(data)) #this question is missing
names(data) <- gsub("^Prolonged deterioration of well-being \\(days\\)2$", "Symptoms5_Severity", names(data))
names(data) <- gsub("^Dizziness2$", "Symptoms6_Severity", names(data))
names(data) <- gsub("^Bleeding from the injection site2$", "Symptoms7_Severity", names(data))
names(data) <- gsub("^Headache2$", "Symptoms8_Severity", names(data))
names(data) <- gsub("^Increased energy level after donating blood2$", "Symptoms9_Severity", names(data))
names(data) <- gsub("^Thirst2$", "Symptoms10_Severity", names(data))

names(data) <- gsub("^During blood donation\\, 450 ml of blood is lost$", "Knowledge1", names(data))
names(data) <- gsub("^Women are allowed to donate blood more often than men$", "Knowledge2", names(data))
names(data) <- gsub("^During blood donation\\, blood donors lose red blood cells$", "Knowledge3", names(data))
names(data) <- gsub("^Blood donors lose iron in connection with blood donation$", "Knowledge4", names(data))

names(data) <- gsub("^During blood donation\\, 450 ml of blood is lost2$", "Knowledge1_Certainty", names(data))
names(data) <- gsub("^Women are allowed to donate blood more often than men2$", "Knowledge2_Certainty", names(data))
names(data) <- gsub("^During blood donation\\, blood donors lose red blood cells2$", "Knowledge3_Certainty", names(data))
names(data) <- gsub("^Blood donors lose iron in connection with blood donation2$", "Knowledge4_Certainty", names(data))

names(data) <- gsub("^Hemoglobin\\'s main function in the body is coagulation$", "KnowledgeHb1", names(data))
names(data) <- gsub("^Hemoglobin transports oxygen in the body$", "KnowledgeHb2", names(data))
names(data) <- gsub("^Hemoglobin is a measure of the body\\'s iron stores$", "KnowledgeHb3", names(data))
names(data) <- gsub("^Hemoglobin is measured at each blood donation$", "KnowledgeHb4", names(data))

names(data) <- gsub("^Hemoglobin\\'s main function in the body is coagulation2$", "KnowledgeHb1_Certainty", names(data))
names(data) <- gsub("^Hemoglobin transports oxygen in the body2$", "KnowledgeHb2_Certainty", names(data))
names(data) <- gsub("^Hemoglobin is a measure of the body\\'s iron stores2$", "KnowledgeHb3_Certainty", names(data))
names(data) <- gsub("^Hemoglobin is measured at each blood donation2$", "KnowledgeHb4_Certainty", names(data))

names(data) <- gsub("^Iron is needed for the production of the body\\'s hemoglobin$", "KnowledgeFer1", names(data))
names(data) <- gsub("^Iron transports oxygen in the body$", "KnowledgeFer2", names(data))
names(data) <- gsub("^Ferritin is a measure of the body\\'s iron stores$", "KnowledgeFer3", names(data))
names(data) <- gsub("^Ferritin is measured at each blood donation$", "KnowledgeFer4", names(data))

names(data) <- gsub("^Iron is needed for the production of the body\\'s hemoglobin2$", "KnowledgeFer1_Certainty", names(data))
names(data) <- gsub("^Iron transports oxygen in the body2$", "KnowledgeFer2_Certainty", names(data))
names(data) <- gsub("^Ferritin is a measure of the body's iron stores2$", "KnowledgeFer3_Certainty", names(data))
names(data) <- gsub("^Ferritin is measured at each blood donation2$", "KnowledgeFer4_Certainty", names(data))

names(data) <- gsub("^Hemoglobin \\(Hb\\)$", "Measurement1", names(data))
names(data) <- gsub("^Transferrin$", "Measurement2", names(data))
names(data) <- gsub("^Ferritin$", "Measurement3", names(data))
names(data) <- gsub("^Hepcidin$", "Measurement4", names(data))
names(data) <- gsub("^Dopamine$", "Measurement5", names(data))

#questions below are all missing
# names(data) <- gsub("^Q57_1$", "ConsequenceHb1", names(data))
# names(data) <- gsub("^Q57_2$", "ConsequenceHb2", names(data))
# names(data) <- gsub("^Q57_3$", "ConsequenceHb3", names(data))
# names(data) <- gsub("^Q57_4$", "ConsequenceHb4", names(data))
# names(data) <- gsub("^Q57_5$", "ConsequenceHb5", names(data))
# names(data) <- gsub("^Q57_6$", "ConsequenceHb6", names(data))
# names(data) <- gsub("^Q57_7$", "ConsequenceHb7", names(data))
# 
# names(data) <- gsub("^Q59_1$", "ConsequenceFer1", names(data))
# names(data) <- gsub("^Q59_2$", "ConsequenceFer2", names(data))
# names(data) <- gsub("^Q59_3$", "ConsequenceFer3", names(data))
# names(data) <- gsub("^Q59_4$", "ConsequenceFer4", names(data))
# names(data) <- gsub("^Q59_5$", "ConsequenceFer5", names(data))
# names(data) <- gsub("^Q59_6$", "ConsequenceFer6", names(data))
# names(data) <- gsub("^Q59_7$", "ConsequenceFer7", names(data))

names(data) <- gsub("^Have you ever been asked to take a break from donating blood because of low ferritin or hemoglobin\\?$", "Deferral", names(data))
names(data) <- gsub("^When was the last time you had a break from donating blood\\?$", "Last_Deferral", names(data))

names(data) <- gsub("^Understandable$", "DeferralInfo1", names(data))
names(data) <- gsub("^Informative$", "DeferralInfo2", names(data))
names(data) <- gsub("^Easy to remember$", "DeferralInfo3", names(data))
names(data) <- gsub("^Useful$", "DeferralInfo4", names(data))
names(data) <- gsub("^Clear$", "DeferralInfo5", names(data))

names(data) <- gsub("^Did you miss any information\\?$", "LackDeferralInfo_process", names(data))
#these have to be created from the column above
# names(data) <- gsub("^Q69_1$", "LackDeferralInfo1", names(data))
# names(data) <- gsub("^Q69_2$", "LackDeferralInfo2", names(data))
# names(data) <- gsub("^Q69_3$", "LackDeferralInfo3", names(data))
# names(data) <- gsub("^Q69_4$", "LackDeferralInfo4", names(data))
# names(data) <- gsub("^Q69_4_TEXT$", "LackDeferralInfoTEXT", names(data))

names(data) <- gsub("^Column$", "Deferral_Motivation1", names(data))
names(data) <- gsub("^The instruction 1$", "Deferral_Motivation2", names(data))

names(data) <- gsub("^Do you know which symptoms are common with iron deficiency\\? \\(multiple answers are possible\\)$", "SymptomsID_process", names(data))
#these have to be created from the one above
# names(data) <- gsub("^Q42_1$", "SymptomsID1", names(data))
# names(data) <- gsub("^Q42_2$", "SymptomsID2", names(data))
# names(data) <- gsub("^Q42_3$", "SymptomsID3", names(data))
# names(data) <- gsub("^Q42_4$", "SymptomsID4", names(data))
# names(data) <- gsub("^Q42_5$", "SymptomsID5", names(data))
# names(data) <- gsub("^Q42_6$", "SymptomsID6", names(data))
# names(data) <- gsub("^Q42_7$", "SymptomsID7", names(data))
# names(data) <- gsub("^Q42_8$", "SymptomsID8", names(data))
# names(data) <- gsub("^Q42_9$", "SymptomsID9", names(data))

names(data) <- gsub("^When you leave blood\\, you lose iron\\. Do you do anything before donating blood to avoid iron deficiency\\? \\(for example by eating an iron\\-rich diet or taking iron tablets\\)\\.$", "AccForIronLoss", names(data))
names(data) <- gsub("^How do you replace the iron loss that occurs when donating blood\\?$", "AccForIronLoss_process", names(data))
#these have to be created from the one above
# names(data) <- gsub("^Q51_1.0$", "AccForIronLoss1", names(data))
# names(data) <- gsub("^Q51_4.0$", "AccForIronLoss2", names(data))
# names(data) <- gsub("^Q51_2.0$", "AccForIronLoss3", names(data))
# names(data) <- gsub("^Q51_3.0$", "AccForIronLoss4A", names(data))
# names(data) <- gsub("^Q51_3_TEXT$", "AccForIronLoss4B", names(data))

names(data) <- gsub("^Blood donation staff$", "DeferralSource1", names(data))
#names(data) <- gsub("^Q53_2$", "DeferralSource2.NL", names(data))
names(data) <- gsub("^Healthcare personnel\\.\\.\\.85$", "DeferralSource3", names(data))
names(data) <- gsub("^The blood center\\'s website or brochure$", "DeferralSource4", names(data))
names(data) <- gsub("^Internet$", "DeferralSource5", names(data))
names(data) <- gsub("^Other source$", "DeferralSource6A", names(data))
#names(data) <- gsub("^Q88_1_TEXT$", "DeferralSource6B", names(data))

names(data) <- gsub("^Blood donation staff2$", "DeferralSource1_Confidence.FI", names(data))
#names(data) <- gsub("^Q53_2$", "DeferralSource2.NL", names(data))
names(data) <- gsub("^Healthcare personnel\\.\\.\\.90$", "DeferralSource3_Confidence.FI", names(data))
names(data) <- gsub("^Blood servicewebsite and\\/or brochure$", "DeferralSource4_Confidence.FI", names(data))
names(data) <- gsub("^Internet2$", "DeferralSource5_Confidence.FI", names(data))
names(data) <- gsub("^Other sources$", "DeferralSource6_Confidence.FI", names(data))
#names(data) <- gsub("^Q88_1_TEXT$", "DeferralSource6B", names(data))

names(data) <- gsub("^Bad \\(1\\) \\- Good \\(5\\)$", "Supplements1", names(data))
names(data) <- gsub("^Harmful \\(1\\) \\- Beneficial \\(5\\)$", "Supplements2", names(data))
names(data) <- gsub("^Should be advised against \\(1\\) \\- Should be recommended \\(5\\)$", "Supplements3", names(data))
names(data) <- gsub("^Meaningless \\(1\\) \\-Meaningful \\(5\\)$", "Supplements4", names(data))

names(data) <- gsub("^Do you take nutritional supplements\\? \\(e\\.g\\. vitamin C\\, vitamin D\\, calcium\\, iron\\, multivitamin tablets\\)$", "SupplementsUse", names(data))
names(data) <- gsub("^What is the name of the dietary supplement\\(s\\) you take or have taken\\?$", "SupplementsUse_Type_A", names(data))
# names(data) <- gsub("^Q73_2$", "SupplementsUse2A.NL", names(data))
# names(data) <- gsub("^Q73_3$", "SupplementsUse3A.NL", names(data))
# names(data) <- gsub("^Q73_1_TEXT$", "SupplementsUse1B.NL", names(data))
# names(data) <- gsub("^Q73_2_TEXT$", "SupplementsUse2B.NL", names(data))
# names(data) <- gsub("^Q73_3_TEXT$", "SupplementsUse3B.NL", names(data))

names(data) <- gsub("^I was recommended by the blood center or by healthcare professionals$", "SupplementsReason1", names(data))
names(data) <- gsub("^Due to health problems$", "SupplementsReason2", names(data))
names(data) <- gsub("^To improve my overall health$", "SupplementsReason3", names(data))
names(data) <- gsub("^Because of my diet \\(e\\.g\\. vegetarian diet\\)$", "SupplementsReason4", names(data))
names(data) <- gsub("^Because I leave blood$", "SupplementsReason5", names(data))
names(data) <- gsub("^Is there another reason you are taking supplements\\? \\(if so what\\)$", "SupplementsReason6A", names(data))
#names(data) <- gsub("^Q89_1_TEXT$", "SupplementsReason6B.NL", names(data))

names(data) <- gsub("^Can you imagine using nutritional supplements in the future\\? Under what conditions\\?$", "SupplementsOpen", names(data))
names(data) <- gsub("^Q34_1_TEXT$", "SupplementsOpen1", names(data))
names(data) <- gsub("^Q34_2_TEXT$", "SupplementsOpen2", names(data))

names(data) <- gsub("^Iron tablets are given by the blood center only to donors with low ferritin levels$", "IronSuppKnowledge1", names(data))
names(data) <- gsub("^Iron tablets can facilitate recovery after donating blood$", "IronSuppKnowledge2", names(data))
names(data) <- gsub("^Iron tablets can only be prescribed with a prescription$", "IronSuppKnowledge3", names(data))
names(data) <- gsub("^Iron tablets can cause side effects$", "IronSuppKnowledge4", names(data))

names(data) <- gsub("^Iron tablets are given by the blood center only to donors with low ferritin levels2$", "IronSuppKnowledge1_Certainty", names(data))
names(data) <- gsub("^Iron tablets can facilitate recovery after donating blood2$", "IronSuppKnowledge2_Certainty", names(data))
names(data) <- gsub("^Iron tablets can only be prescribed by prescription 2$", "IronSuppKnowledge3_Certainty", names(data))
names(data) <- gsub("^Iron tablets can cause side effects2$", "IronSuppKnowledge4_Certainty", names(data))

names(data) <- gsub("^Do you know the possible side effects of iron tablets\\? \\(multiple answers possible\\)$", "IronSuppSE_process", names(data))
#create from column above
# names(data) <- gsub("^Q37_1$", "IronSuppSE1", names(data))
# names(data) <- gsub("^Q37_2$", "IronSuppSE2", names(data))
# names(data) <- gsub("^Q37_3$", "IronSuppSE3", names(data))
# names(data) <- gsub("^Q37_4$", "IronSuppSE4", names(data))
# names(data) <- gsub("^Q37_5$", "IronSuppSE5", names(data))
# names(data) <- gsub("^Q37_6$", "IronSuppSE6", names(data))
# names(data) <- gsub("^Q37_7$", "IronSuppSE7.NL", names(data))
# names(data) <- gsub("^Q37_8$", "IronSuppSE8", names(data))
# names(data) <- gsub("^Q37_9$", "IronSuppSE9", names(data))

names(data) <- gsub("^Have you ever taken iron supplements\\?$", "IronSuppUse", names(data))

names(data) <- gsub("^Fitness$", "IronSuppEffect1", names(data))
names(data) <- gsub("^Fatigue3$", "IronSuppEffect2", names(data))
names(data) <- gsub("^Dizziness3$", "IronSuppEffect3", names(data))
names(data) <- gsub("^Headache3$", "IronSuppEffect4", names(data))
names(data) <- gsub("^Stomach problems$", "IronSuppEffect5", names(data))
names(data) <- gsub("^Do you find that iron supplements have any other health effects\\, if so what\\?$", "IronSuppEffect6A", names(data))
#names(data) <- gsub("^Q71_1_TEXT$", "IronSuppEffect6B", names(data))

names(data) <- gsub("^I am not sure if iron tablets have negative effects on my health$", "ConcernIronSupp1", names(data))
names(data) <- gsub("^I only want to take iron tablets if I have any problems$", "ConcernIronSupp2", names(data))
names(data) <- gsub("^I think iron tablets are making my health worse$", "ConcernIronSupp3", names(data))
names(data) <- gsub("^I\\'d rather eat more iron\\-containing food than take iron tablets$", "ConcernIronSupp4", names(data))
names(data) <- gsub("^Is there anything else that would prevent you from taking iron tablets\\? \\(Please specify what\\)$", "ConcernIronSupp5A", names(data))
#names(data) <- gsub("^If yes\\, please tell us the details\\.$", "ConcernIronSupp5B", names(data))

names(data) <- gsub("^Do you usually take the iron tablets you get from the blood center\\?$", "IronSuppSwe", names(data))

# names(data) <- gsub("^Q40_1$", "IronSuppSanq1", names(data))
# names(data) <- gsub("^Q40_2$", "IronSuppSanq2", names(data))
# names(data) <- gsub("^Q40_3$", "IronSuppSanq3", names(data))
# names(data) <- gsub("^Q40_4$", "IronSuppSanq4", names(data))
# names(data) <- gsub("^Q40_5$", "IronSuppSanq5", names(data))
# names(data) <- gsub("^Q40_6$", "IronSuppSanq6", names(data))
# names(data) <- gsub("^Q40_7$", "IronSuppSanq7", names(data))
# names(data) <- gsub("^Q40_8$", "IronSuppSanq8", names(data))
# names(data) <- gsub("^Q40_9$", "IronSuppSanq9", names(data))

# names(data) <- gsub("^Q41$", "IronSuppSanqReason", names(data)) #IronSupp_BloodService
# 
# names(data) <- gsub("^Q41_3_TEXT$", "IronSuppSanqReasonB", names(data))

names(data) <- gsub("^Suppose you are found to have low iron stores\\, which of the following options do you prefer\\? \\(rank from best \\(top\\) to worst option \\(bottom\\)$", "IronDefPref_process", names(data))
#have to be created from column above
# names(data) <- gsub("^Q77_1$", "IronDefPref1", names(data))
# names(data) <- gsub("^Q77_2$", "IronDefPref2", names(data))
# names(data) <- gsub("^Q77_3$", "IronDefPref3", names(data))
# names(data) <- gsub("^Q77_4$", "IronDefPref4", names(data))

names(data) <- gsub("^If I had health problems that could be remedied with the iron tablets$", "IronSuppSanqCondition1", names(data))
names(data) <- gsub("^To prevent potential health problems$", "IronSuppSanqCondition2", names(data))
names(data) <- gsub("^If it allowed me to continue donating blood regularly$", "IronSuppSanqCondition3", names(data))
names(data) <- gsub("^If the blood center doctor recommended me to take the iron tablets$", "IronSuppSanqCondition4", names(data))
names(data) <- gsub("^If there is scientific evidence that the iron tablets improve the body's iron stores$", "IronSuppSanqCondition5", names(data))
names(data) <- gsub("^I wouldn\\'t want to take the iron tablets$", "IronSuppSanqCondition6", names(data))

names(data) <- gsub("What do you think is the most important thing for the blood center to take into account regarding the formulation of recommendations for blood donors with low iron stores? (top - highest priority, along the bottom - lowest priority...", "IronSuppSanq_process", names(data), fixed=T)
#have to be created from column above
# names(data) <- gsub("^Q81_1$", "IronSuppSanqReason1", names(data))
# names(data) <- gsub("^Q81_2$", "IronSuppSanqReason2", names(data))
# names(data) <- gsub("^Q81_3$", "IronSuppSanqReason3", names(data))
# names(data) <- gsub("^Q81_4$", "IronSuppSanqReason4", names(data))
# names(data) <- gsub("^Q81_5$", "IronSuppSanqReason5", names(data))


colnames(data)
```
# Translate answers

```{r}
#create menstruation other
data <- data %>% mutate(Menstruation = ifelse(Sex == "MAN", NA, Menstruation), Menstruation_other = Menstruation, Menstruation_other = ifelse(Menstruation_other %in% c("Yes", "No, because of menopause", "No, because of contraception"), NA, Menstruation_other), Menstruation = ifelse(!(Menstruation %in% c("Yes", "No, because of menopause", "No, because of contraception", NA)), "No, other", Menstruation))

#recode Area:If you want to convert the responses Umeå is a city with more than 100 000 residents, whereas all other cities have less than 100 000 inhabitants.
data <- data %>% mutate(Area = ifelse(Area == "Umeå", "City, 100,000 or more", "City or town, < 100,000 residents"))

#Map education
data <- data %>% mutate(Education = ifelse(grepl("Gym", Education), "High school", Education), Education = ifelse(!(Education %in% c("Other",
"None",
"Primary school", 
"High school",
"College",
"Applied sciences",
"University")), "Other", Education))

#create lackdeferralinfo 
#LackDeferralInfo
data <- data %>%
  mutate(
    # Create binary columns for each predefined answer option using regex to match the content
    LackDeferralInfo1 = sapply(as.character(LackDeferralInfo_process), function(x) ifelse(grepl("Information about what hemoglobin and\\/or ferritin are", x), 1, 0)),
    LackDeferralInfo5 = sapply(as.character(LackDeferralInfo_process), function(x) ifelse(grepl("Information about the consequences of low hemoglobin and\\/or ferritin", x), 1, 0)),
    LackDeferralInfo2 = sapply(as.character(LackDeferralInfo_process), function(x) ifelse(grepl("Information on how best to restore hemoglobin and\\/or ferritin levels", x), 1, 0)),
    LackDeferralInfo3 = sapply(as.character(LackDeferralInfo_process), function(x) ifelse(grepl("No information was missing", x), 1, 0)),
    
    # Capture any open text answers that do not match predefined options
    LackDeferralInfoTEXT = sapply(as.character(LackDeferralInfo_process), function(x) {
      if (is.na(x)) {
        return(NA)
      }
      predefined_patterns <- c("Information about what hemoglobin and\\/or ferritin are", 
                               "Information about the consequences of low hemoglobin and\\/or ferritin", 
                               "Information on how best to restore hemoglobin and\\/or ferritin levels", 
                               "No information was missing")
      # Remove predefined patterns from the string
      remaining_text <- trimws(gsub(paste(predefined_patterns, collapse = "|"), "", x))
      if (nchar(remaining_text) > 0) {
        return(remaining_text)
      } else {
        return(NA)
      }
    }),
    LackDeferralInfo5 = sapply(as.character(LackDeferralInfoTEXT), function(x) {
      if(is.na(x)){
      return(0)
    } else if (nchar(x) > 0){
      return(1)
    }
    }) 
  )

data <- data %>% select(-"LackDeferralInfo_process")

#create SymptomsID
data <- data %>%
  mutate(
    # Create binary columns for each predefined answer option using regex to match the content
    SymptomsID1 = sapply(as.character(SymptomsID_process), function(x) ifelse(grepl("Restless", x), 1, 0)),
    SymptomsID2 = sapply(as.character(SymptomsID_process), function(x) ifelse(grepl("Dark stools", x), 1, 0)),
    SymptomsID3 = sapply(as.character(SymptomsID_process), function(x) ifelse(grepl("Fatigue", x), 1, 0)),
    SymptomsID4 = sapply(as.character(SymptomsID_process), function(x) ifelse(grepl("Stomach", x), 1, 0)),
    SymptomsID5 = sapply(as.character(SymptomsID_process), function(x) ifelse(grepl("chew", x), 1, 0)),
    SymptomsID6 = sapply(as.character(SymptomsID_process), function(x) ifelse(grepl("Headache", x), 1, 0)),
    SymptomsID7 = sapply(as.character(SymptomsID_process), function(x) ifelse(grepl("None of the above", x), 1, 0)),
    SymptomsID8 = sapply(as.character(SymptomsID_process), function(x) ifelse(grepl("I don\\'t know", x), 1, 0))
  )

data <- data %>% select(-"SymptomsID_process")

#create AccForIronLoss1-4
data <- data %>%
  mutate(
    # Create binary columns for each predefined answer option using regex to match the content
    AccForIronLoss1 = sapply(as.character(AccForIronLoss_process), function(x) ifelse(grepl("Eat more iron-rich diet", x), 1, 0)),
    AccForIronLoss2 = sapply(as.character(AccForIronLoss_process), function(x) ifelse(grepl("Take multivitamins with iron content", x), 1, 0)),
    AccForIronLoss3 = sapply(as.character(AccForIronLoss_process), function(x) ifelse(grepl("Taking iron tablets", x), 1, 0)),
    AccForIronLoss3 = sapply(as.character(AccForIronLoss_process), function(x) ifelse(grepl("tablets", x), 1, AccForIronLoss3)),
    AccForIronLoss5 = sapply(as.character(AccForIronLoss_process), function(x) ifelse(grepl("Do nothing active to replace the loss", x), 1, 0))
  )

data <- data %>% select(-"AccForIronLoss_process")

#create supplements reason other


#transform supplements open into yes/no

#create ironsuppse1-9

#transform IronSuppEffect6A

#transform ConcernIronSupp6A

#create irondefpref1-5


```


## Mapping functions 

```{r}
#

#col 11 and 12 

f1 <- function (x){
  x <- fct_recode(x,  
                  "Disagree" = "2",
                  "Neutral"="3",
                  "Agree"="4",
                  "Totally disagree" =  "1",
                  "Totally agree" = "5"
  )
  x <- factor(
    x,
    levels = c("Totally disagree","Disagree","Neutral","Agree","Totally agree"),
    ordered = TRUE
  )
  x
}

f2 <- function (x){
  x <- fct_recode(x,  
                  "Never" = "1",
                  "Sometimes" = "2",
                  "Often" = "3",
                  "Always" = "4"
  )
  x <- factor(
    x,
    levels = c("Never","Sometimes","Often","Always"),
    ordered = TRUE
  )
  x  
}

f3 <- function (x){
  x <- fct_recode(x,  
                  "Yes" = "1",
                  "No" = "2",
                  "I don't know" = "4"
                  )
  x <- factor(
    x,
    levels=c("Yes","No","I don't know"),
    ordered = TRUE
  )
  x
}

f4 <- function (x){
  x <- fct_recode(x,
                  "FALSE" = "2",
                  "TRUE" = "1"
                  
                  )
  x <- factor(
    x,
    levels=c("FALSE","TRUE"),
  )
  x
}

f5 <- function (x){
  x <- fct_recode(x,
                  "50/50" = "1",
                  "100%" = "2"
                  
                  )
  x <- factor(
    x,
    levels=c("50/50","100%"),
  )
  x
}


f6 <- function (x){
  x <- fct_recode(x,
                  "No" = "2",
                  "Yes" = "1"
                  
                  )
  x <- factor(
    x,
    levels=c("No","Yes"),
  )
  x
}


f7 <- function(x) {
  x <- as.character(x)
  x[is.na(x)] <- "FALSE"  # Convert NA values to "FALSE"
  x <- forcats::fct_recode(x,
                           "FALSE" = NA_character_,
                           "TRUE" = "1"
  )
  x <- factor(x,
              levels = c("FALSE", "TRUE")
  )
  x
}

f8 <- function (x){ #HIER AANPASSEN
  x <- fct_recode(x,  
                  "Increased" = "3",
                  "No effect" = "2",
                  "Decreased" = "1"
  )
  x <- factor(
    x,
    levels=c("Increased","No effect","Decreased"),
  )
  x
}

f9 <- function (x){
  x <- fct_recode(x,
                  "Agree" = "1",
                  "Disagree" = "2"
                  )
  x <- factor(
    x,
    levels=c("Agree","Disagree"),
  )
  x
}


f11 <- function (x){
  x <- factor(
    x,
    levels=c("1","2","3","4","5"),
    ordered = TRUE
  )
  x
}


```


## Main processing

```{r}
#Columns containing just 0 or 1
zero1cols <- data %>%  
  summarise(across(everything(), ~ str_c(names(table(.x)),collapse="") == "01"))


data[] <- lapply(data, as.factor)


# Statements: Totally disagree - Totally agree
tmp <- data %>% 
  mutate_at(vars(which(str_detect(colnames(data), "\\bOpinionBloodService1\\b|\\bOpinionBloodService2\\b|\\bOpinionBloodService3\\b|\\bOpinionBloodService4\\b|\\bOpinionBloodService5\\b|\\bOpinionBloodService6\\b|\\bOpinionBloodService7\\b|\\bOpinionBloodService8\\b|\\bIronSuppSanq1\\b|\\bIronSuppSanq2\\b|\\bIronSuppSanq3\\b|\\bIronSuppSanq4\\b|\\bIronSuppSanq5\\b|\\bIronSuppSanq6\\b|\\bIronSuppSanq7\\b|\\bIronSuppSanq8\\b|\\bIronSuppSanq9\\b"))), ~ f1(.)) %>% 
  mutate_at(vars(which(colnames(data) %in% c("Symptoms1", "Symptoms2", "Symptoms3", "Symptoms4", "Symptoms5", "Symptoms6"))), ~ f2(.)) %>% 
  mutate_at(vars(which(str_detect(colnames(data), "Measurement"))), ~ f3(.))%>% 
  mutate_at(vars(which(colnames(data) %in% c("Knowledge1","Knowledge2","Knowledge3","Knowledge4","KnowledgeHb1","KnowledgeHb2","KnowledgeHb3","KnowledgeHb4","KnowledgeFer1","KnowledgeFer2","KnowledgeFer3","KnowledgeFer4","IronSuppKnowledge1","IronSuppKnowledge2","IronSuppKnowledge3","IronSuppKnowledge4"))), ~ f4(.)) %>% 
  mutate_at(vars(which(str_detect(colnames(data), "_Certainty"))), ~ f5(.)) %>% 
  mutate_at(vars(which(colnames(data) %in% c("AccForIronLoss", "SupplementsUse.NL", "SupplementsOpen", "SupplementsReason6A"))), ~ f6(.))%>% 
  mutate_at(vars(which(str_detect(colnames(data), "\\bConsequenceHb1\\b|\\bConsequenceHb2\\b|\\bConsequenceHb3\\b|\\bConsequenceHb4\\b|\\bConsequenceHb5\\b|\\bConsequenceHb6\\b|\\bConsequenceHb7\\b|\\bConsequenceFer1\\b|\\bConsequenceFer2\\b|\\bConsequenceFer3\\b|\\bConsequenceFer4\\b|\\bConsequenceFer5\\b|\\bConsequenceFer6\\b|\\bConsequenceFer7\\b|\\bSymptomsID1\\b|\\bSymptomsID2\\b|\\bSymptomsID3\\b|\\bSymptomsID4\\b|\\bSymptomsID5\\b|\\bSymptomsID6\\b|\\bSymptomsID7\\b|\\bSymptomsID8\\b|\\bSymptomsID9\\b|\\bAccForIronLoss1\\b|\\bAccForIronLoss2\\b|\\bAccForIronLoss3\\b|\\bAccForIronLoss4A\\b|\\bDeferralSource1\\b|\\bDeferralSource2.NL\\b|\\bDeferralSource3\\b|\\bDeferralSource4\\b|\\bDeferralSource5\\b|\\bDeferralSource6A\\b|\\bSupplementsUse1A.NL\\b|\\bSupplementsUse2A.NL\\b|\\bSupplementsUse3A.NL\\b|\\bSupplementsReason1\\b|\\bSupplementsReason2\\b|\\bSupplementsReason3\\b|\\bSupplementsReason4\\b|\\bSupplementsReason5\\b|\\bIronSuppKnowledge1\\b|\\bIronSuppKnowledge2\\b|\\bIronSuppKnowledge3\\b|\\bIronSuppKnowledge4\\b|\\bIronSuppSE1\\b|\\bIronSuppSE2\\b|\\bIronSuppSE3\\b|\\bIronSuppSE4\\b|\\bIronSuppSE5\\b|\\bIronSuppSE6\\b|\\bIronSuppSE7.NL\\b|\\bIronSuppSE8\\b|\\bIronSuppSE9\\b|"))), ~ f7(.)) %>% 
  mutate_at(vars(which(str_detect(colnames(data), "\\bIronSuppEffect1\\b|\\bIronSuppEffect2\\b|\\bIronSuppEffect3\\b|\\bIronSuppEffect4\\b|\\bIronSuppEffect5\\b|\\bIronSuppEffect6A\\b|"))), ~f8(.)) %>%
  mutate_at(vars(which(colnames(data) %in% c("IronSuppSanqCondition1", "IronSuppSanqCondition2", "IronSuppSanqCondition3", "IronSuppSanqCondition4", "IronSuppSanqCondition5", "IronSuppSanqCondition6"))), ~ f9(.)) %>%
  mutate_at(vars(which(str_detect(colnames(data), "\\bSymptoms1_Severity\\b|\\bSymptoms2_Severity\\b|\\bSymptoms3_Severity\\b|\\bSymptoms4_Severity\\b|\\bSymptoms5_Severity\\b|\\bSymptoms6_Severity\\b|\\bSymptoms7_Severity\\b|\\bSymptoms8_Severity\\b|\\bSymptoms9_Severity\\b|\\bSymptoms10_Severity\\b|\\bDeferral\\b|\\bLast_Deferral\\b|\\bDeferralInfo1\\b|\\bDeferralInfo2\\b|\\bDeferralInfo3\\b|\\bDeferralInfo4\\b|\\bDeferralInfo5\\b|\\bLackDeferralInfoTEXT\\b|\\bDeferral_Motivation1\\b|\\bDeferral_Motivation2\\b|\\bDeferralSource6B\\b|\\bSupplements1\\b|\\bSupplements2\\b|\\bSupplements3\\b|\\bSupplements4\\b|\\bIronSuppSanqReason\\b|\\bIronSuppSanqReasonB.NL\\b|\\bIronDefPref1\\b|\\bIronDefPref2\\b|\\bIronDefPref3\\b|\\bIronDefPref4\\b|\\bIronSuppSanqReason1\\b|\\bIronSuppSanqReason2\\b|\\bIronSuppSanqReason3\\b|\\bIronSuppSanqReason4\\b|\\bIronSuppSanqReason5\\b|\\bDeferral_Motivation1\\b|\\bDeferral_Motivation2\\b"))), ~ f11(.))



tmp <- tmp %>% 
  mutate(
    Sex =  fct_recode(Sex,  
                  "Male" = "1",
                  "Female" = "2",
                  "Non-binary" = "3",
                  "Other" = "4",
                  "Prefer not to say" = "5"
                  ),
    Menstruation = fct_recode(Menstruation,  
    "Yes" = "1",
    "No, due to current pregnancy" = "2",
    "No, due to menopause" = "3",
    "No, due to current contraception use" = "4",
    "No, due to a different reason" = "5"
     ),  
    Area = fct_recode(Area,
                     "In a city of over 100,000 people" = "1",
                    "In a town of less than 100,000 people, or in the countryside" = "2"
                                                 
     ),
    Education =fct_recode(Education,
"None" = "1",
"Primary school" = "2", 
"High school" = "3",
"College" = "4",
"Applied sciences" = "5",
"University" = "6",
"Other" = "7"
      ) %>% fct_relevel(
"Other",
"None",
"Primary school", 
"High school",
"College",
"Applied sciences",
"University"
      ) %>% as.ordered(.)
,
   Health = fct_recode(Health,
"Excellent" =  "1",
"Very good" =  "2",
"Good" =   "3",
"Fair" =  "4",
"Poor" =  "5"
) %>% fct_relevel(.,
"Poor",
"Fair",
"Good",
"Very good",
"Excellent",  
) %>% as.ordered(.)
,
    Diet =
  str_replace_all(data$Diet,"\\(|\\)","_") %>% 
    fct_recode(.,
      "Yes, vegan (no animal products)" =  "1",
"Yes, vegetarian (no meat and no fish)" =  "2",
"Yes, pescatarian (no meat)" =  "3",
"Yes, flexitarian (at least three days without meat)" = "4" ,
"No" = "5"
    ),    
    Number_donation = fct_recode(Number_donation,
      "1 - 3 times" = "1",
"4 - 10 times" = "2",
"More than 10 times" = "3",
"None" = "4",
"I don't know" = "5",
"More than 30 times" = "6"
    ) %>% fct_relevel(.,
    "I don't know",
    "None",
    "1 - 3 times",
"4 - 10 times",
"More than 10 times",
"More than 30 times"
) %>% as.ordered(.)
,
    Last_donation = fct_recode(Last_donation,
"Within the last 6 months" =  "1",
"6 months to a year ago" =  "2",
"1-2 years ago" =  "3",
"More than 2 years ago" =  "4",
"I cannot remember" = "5",
    ) %>% fct_relevel(.,
"Within the last 6 months",
"6 months to a year ago",
"1-2 years ago",
"More than 2 years ago",
"I cannot remember"
                      ) %>% as.ordered(.)

,
Deferral
=fct_recode(Deferral,
            "No" = "3",
            "I don’t know"= "4",
            "Yes, once "= "1",
            "Yes, multiple times "= "2"
            
),
       
SupplementsUse.NL =
  fct_recode(SupplementsUse.NL,
             "Never" = "1",
             "Not anymore" =  "4",
             "Sometimes" =  "2",
             "Every day" =  "3"
  ),
IronSuppUse =
  fct_recode(IronSuppUse,
             "No, I have never taken iron (containing) supplements" = "5",
             "Yes, I am currently taking iron supplements ordered to me by a doctor"    = "1",
             "Yes, I am currently taking iron supplements from a drugstore"   =  "2", 
             "Yes, I take multivitamins that contain iron"  =  "3",
             "I have taken iron supplements/multivitamins before, but not anymore"      = "4" 
             
  ),
IronSuppSanqReason =
  fct_recode(IronSuppSanqReason,
             "To improve my health" = "1",
             "To be able to continue to donate"    = "2",
             "Different reason"   =  "3", 
             "I would never make use of iron supplements provided by the blood service"  =  "4"
             
  )



  )
  
```


# Deal with open text answers

## 3: something_in_some_language

```{r}
tmp %>% count(Menstruation) %>% arrange(desc(n)) %>% print( n = 1e3)
```


```{r}


# tmp <- tmp %>%  
#   mutate(
#     `something_in_some_language` = str_remove_all(`something_in_some_language`,"\""), # there we some extra '\' that needed to be removed
#   `3: something_in_some_language` = fct_recode(`3: something_in_some_language`,
#  "No, other" =              "something_in_some_language",
#  "No, other" =              "something_in_some_language",
#  #... maybe some other alternative open text answers
#   "No, due to menopause" =  "something_in_some_language",
# # ...
#    "No, due to current contraception use"  =           "something_in_some_language",
# #... 
#   "No, due to hysterectomy" =             "something_in_some_language",
# "No, due to menopause"    =           "something_in_some_language",
#   "No, other" =             "something_in_some_language",
# 
# )
# )
# 
# tmp %>% count(`3: something_in_some_language`) %>% arrange(desc(n)) %>% print( n = 1e3)


```


## 5: Mikä on korkein suorittamasi koulutusaste?


```{r}
tmp %>% count(Education) %>% arrange(desc(n)) %>% print( n = 1e3)


```

```{r}
#tmp1 <- tmp
#tmp <- tmp1

# EDUCATION
tmp$Education_other.NL <- as.character(tmp$Education_other.NL)
tmp$Education_other.NL <- ifelse(grepl("HBO", tmp$Education_other.NL), "5", tmp$Education_other.NL)
tmp$Education_other.NL <- ifelse(grepl("Hbo",tmp$Education_other.NL), "5", tmp$Education_other.NL)
tmp$Education_other.NL <- ifelse(grepl("LEAO", tmp$Education_other.NL), "5", tmp$Education_other.NL)
tmp$Education_other.NL <- ifelse(grepl("HBS", tmp$Education_other.NL), "5", tmp$Education_other.NL)
tmp$Education_other.NL <- ifelse(grepl("Mafo",tmp$Education_other.NL), "4", tmp$Education_other.NL)
tmp$Education_other.NL <- ifelse(grepl("Z opleiding",tmp$Education_other.NL), "4", tmp$Education_other.NL)
tmp$Education_other.NL <- ifelse(grepl("MAVO",tmp$Education_other.NL), "4", tmp$Education_other.NL)
tmp$Education_other.NL <- ifelse(grepl("Mavo",tmp$Education_other.NL), "4", tmp$Education_other.NL)
tmp$Education_other.NL <- ifelse(grepl("PhD",tmp$Education_other.NL), "6", tmp$Education_other.NL)
tmp$Education_other.NL <- ifelse(grepl("Post",tmp$Education_other.NL), "6", tmp$Education_other.NL)
tmp$Education_other.NL <- ifelse(grepl("post",tmp$Education_other.NL), "6", tmp$Education_other.NL)
tmp$Education_other.NL <- ifelse(grepl("Master",tmp$Education_other.NL), "6", tmp$Education_other.NL)
tmp$Education_other.NL <- ifelse(grepl("Lts",tmp$Education_other.NL), "4", tmp$Education_other.NL)
tmp$Education_other.NL <- ifelse(grepl("Huishoudschool",tmp$Education_other.NL), "3", tmp$Education_other.NL)
tmp$Education_other.NL <- ifelse(grepl("HAVO",tmp$Education_other.NL), "3", tmp$Education_other.NL)
tmp$Education_other.NL <- ifelse(grepl("Niet relevant",tmp$Education_other.NL), " ", tmp$Education_other.NL)

tmp <- tmp  %>%
  mutate(Education = case_when(
    Education == "None" ~ "None",
    Education == "Primary school" ~ "Primary school", # Basisschool
    Education == "High school" ~ "High school", # Middelbare school
    Education == "College" ~ "College", # MAVO
    Education == "Applied sciences" ~ "Applied sciences", # HBO
    Education == "University" ~ "University", # Universiteit
    Education == "Other" & (Education_other.NL == "3") ~ "High school",
    Education == "Other" & (Education_other.NL == "4") ~ "College",
    Education == "Other" & (Education_other.NL == "5") ~ "Applied sciences",
    Education == "Other" & (Education_other.NL == "6") ~ "University"
)) 

tmp %>% count(Education) %>% arrange(desc(n)) %>% print( n = 1e3)
```


## 24: Mistä olisit halunnut lisätietoja?


```{r}
#tmp %>% count(`24: something_in_some_language`) %>% arrange(desc(n)) %>% print( n = 1e3)
```




```{r}
# tmp <- tmp %>% mutate(
# `24: something_in_some_language` = 
#   fct_recode(`24: something_in_some_language`,
#     "Other"= "something_in_some_language", 
#     "Iron stores/ferritin" = "something_in_some_language", 
#     "Other" = "something_in_some_language", 
#     "Information on the consequences of low hemoglobin levels" = "something_in_some_language", 
#     "Information on how to restore hemoglobin levels" = "something_in_some_language", 
#     "Information on what hemoglobin is" = "something_in_some_language", 
#    "No information was missing" =  "something_in_some_language" 
# 
#   ),
# )

```


```{r}
#tmp %>% count(`24: something_in_some_language`) %>% arrange(desc(n)) %>% print( n = 1e3)
```


## 36: Onko olemassa jokin muu syy, miksi käytät tai olet käyttänyt ravintolisiä?`


```{r}
# tmp %>% count(`36: something_in_some_language`) %>% arrange(desc(n)) %>% print( n = 1e3)
```



```{r}
# tmp <- tmp %>% mutate(
#   `36: something_in_some_language` =
#     case_when(
#       !is.na(`36: something_in_some_language`) & 
#         `36: something_in_some_language` != "No" ~ "Other",
#       TRUE ~ `36: something_in_some_language`
#           ),        
#    `36: something_in_some_language` = 
#     as_factor(`36: something_in_some_language`)    
# 
# )
```


```{r}
# tmp %>% count(`36: something_in_some_language`) %>% arrange(desc(n)) %>% print( n = 1e3)
```


## 44: Askarruttaako jokin muu rautalisiin liittyvä asia sinua?


```{r}
#tmp %>% count(`44: something_in_some_language`) %>% arrange(desc(n)) %>% print( n = 1e3)

```


```{r}
# tmp <- tmp %>% mutate(
#   `44: something_in_some_language` =
#     case_when(
#       !is.na(`44: something_in_some_language`) & 
#         `44: something_in_some_language` != "No" ~ "Other",
#       TRUE ~ `44: something_in_some_language`
#           ),        
#    `44: something_in_some_language` = 
#     as_factor(`44: something_in_some_language`)
# )
```


```{r}
# tmp %>% count(`44: something_in_some_language`) %>% arrange(desc(n)) %>% print( n = 1e3)
```

## 46: Mikä on sinulle tärkein syy ottaa vastaan Veripalvelun tarjoama rautalisä?


```{r}
 tmp %>% count(IronSuppSanqReason) %>% arrange(desc(n)) %>% print( n = 1e3)
```



## Removed open texts

### 37.1: Voisitko harkita ravintolisien käyttöä?: Kyllä, koska

```{r}
#tmp %>% count(`37.1: something_in_some_language`) %>% arrange(desc(n)) %>% print( n = 1e3)
```


### 37.2: Voisitko harkita ravintolisien käyttöä?: En, koska

```{r}
#tmp %>% count(`37.2: something_in_some_language`) %>% arrange(desc(n)) %>% print( n = 1e3)
 
```


```{r}
summary(tmp)
```


```{r}
#cut age for summarisation

tmp$Age <- as.numeric((as.character(tmp$Age)))
tmp$Age <- cut(tmp$Age,breaks=c(min(tmp$Age),seq(from=20,to=75,by=10),max(tmp$Age)),include.lowest = TRUE)
tmp$Age <- factor(tmp$Age,ordered = TRUE)

```



```{r}
#Export summary count data
DataExport <- apply(tmp,MARGIN = 2,FUN = table)
saveRDS(DataExport,file="L:/DonorMedicin/FORTE/E Internation Donor Perception Survey/B Analysis/R/2. Datasets/1. iDPS - Summary data - NL.RDS")

```


# Summarise 

```{r}
Summary_NL <- dfSummary(tmp,
          plain.ascii = FALSE, 
          style = "grid", 
          graph.col = TRUE,
          graph.magnif = 0.75, 
          valid.col = FALSE, 
          tmp.img.dir = "/tmp")




```



# Save dataset
```{r}


datanl <- saveRDS("../data/countnl.RDS")




```

