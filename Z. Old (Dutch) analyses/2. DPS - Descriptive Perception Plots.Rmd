---
title: "DPS - Perception Plots"
author: "Jan Karregat"
date: "`r Sys.Date()`"
output: html_document
---

```{r} 
Sys.setlocale("LC_MESSAGES", 'en_GB.UTF-8')
Sys.setenv(LANG = "en_US.UTF-8")

knitr::opts_chunk$set(
        echo = FALSE,
        message = FALSE,
        warning = FALSE
)

currentDate <- format(Sys.time(), "%Y-%m-%d")
FolderName <- paste("L:/DonorMedicin/FORTE/B Donor Perception Survey/B Analysis/R/3. Plots/", currentDate,sep="")
dir.create(FolderName)


library(plyr)
library(readr)
library(nFactors)
library(psych)
library(corrplot)
library(psych)
library(likert)
library(ggplot2)
library(tidyverse)
library(ggthemes)
library(haven)
library(rsample)
library(broom)
library(scales)
library(kableExtra)
library(boot)
library(naniar)
library(haven)
library(foreign)
library(tidyverse)
library(tableone)
library(stargazer)
library(gridExtra)
library(cowplot)
library(broom)
library(GGally)
library(ggfortify)
library(knitr)
library(lubridate)
library(car)
library(reshape2)
library(sfsmisc)
library(MASS)
library(ordinal)
library(sjmisc)
library(VIM)
library(epiDisplay)
library(epitools)
library(ez)
library(ggbeeswarm)
library(ggthemes)
library(rsample)
library(broom)
library(scales)
library(kableExtra)
library(boot)
library(readxl)
library(foreign)
library(corrr)
library(reshape2)
library(ggcorrplot)
library(tidylog, warn.conflicts = F)
```


```{r pressure, echo=FALSE}
Data <- readRDS("L:/DonorMedicin/FORTE/B Donor Perception Survey/B Analysis/R/2. Datasets/2. DPS - Complete Cleaned")
```

                       
                     

# Tabl 1.
```{r}
Table1 <- Data
Table1[sapply(Table1, is.character)] <- lapply(Table1[sapply(Table1, is.character)], 
                                       as.factor)

Table1$Deferral <- gsub("Deferred once", "Once", Table1$Deferral)
Table1$Deferral <- gsub("Deferred multiple times", "More than once", Table1$Deferral)
Table1$Deferral <- gsub("Never deferred", "Never", Table1$Deferral)
Table1$Finished <- gsub("0", "No", Table1$Finished)
Table1$Finished <- gsub("1", "Yes", Table1$Finished)

Table1$Education <- factor(Table1$Education, levels=c('Low','Middle','High'))
Table1$Health <- factor(Table1$Health, levels=c('Mediocre','Good','Very good', 'Excellent'))
Table1$Deferral <- factor(Table1$Deferral, levels=c('Never','Once','More than once'))
Table1$DonorCareer <- factor(Table1$DonorCareer, levels=c('New','Beginner','Experienced'))



myVars <- c("Sex", "Age" ,
  "DonorCareer", "Education", "Deferral", "Trust", "IronSuppUse", "AccountForIronLossAfterDonation", "Open_Towards_Dietary_Suppl"
)
table1data <- Table1  

summary_table <- CreateTableOne(data = 
                                  table1data,
                                vars=myVars,
                                test = FALSE)


tab3Mat <- print(summary_table, 
                 showAllLevels = TRUE,
                 #nonnormal = non_normal_vars,
                 vars=myVars, 
                 quote = FALSE, 
                 noSpaces = TRUE, 
                 printToggle = FALSE)


colnames(tab3Mat) <- gsub("\\:",": ",colnames(tab3Mat))


tab3Mat %>% 
  kable() %>% 
kable_styling(
  full_width = F,
  bootstrap_options = "striped", 
  font_size = 8) 
```

## Perception of iron supplementation as a policy 
# [Outcome variables: Willingness, Invasiveness, and Conditions]
# If the blood service would provide iron supplements...

```{r}
Willingness_Iron <- Data[,c(4, 160:168)]
names(Willingness_Iron)[names(Willingness_Iron) == "IronSuppSanq1"] <- "I would gladly make use of this"
names(Willingness_Iron)[names(Willingness_Iron) == "IronSuppSanq2"] <- "I would have a positive attitude towards this"
names(Willingness_Iron)[names(Willingness_Iron) == "IronSuppSanq3"] <- "I think it is important that a physician is involved"
names(Willingness_Iron)[names(Willingness_Iron) == "IronSuppSanq4"] <- "I think it is important that my iron levels are monitored more often"
names(Willingness_Iron)[names(Willingness_Iron) == "IronSuppSanq5"] <- "This would have a negative effect on my motivation to donate"
names(Willingness_Iron)[names(Willingness_Iron) == "IronSuppSanq6"] <- "I would find this pushy"
names(Willingness_Iron)[names(Willingness_Iron) == "IronSuppSanq7"] <- "I think too much is being asked of donors"
names(Willingness_Iron)[names(Willingness_Iron) == "IronSuppSanq8"] <- "I would like to receive more information about this first"
names(Willingness_Iron)[names(Willingness_Iron) == "IronSuppSanq9"] <- "I would prefer this over deferral"

# Create datasets for men and women 
Willingness_Iron_M <- Willingness_Iron %>% filter(Sex == "Men")
Willingness_Iron_W <- Willingness_Iron %>% filter(Sex == "Women")

# HEATMAP - Complete
Perception_Iron_Likert <- Willingness_Iron %>% select(-Sex)
Perception_Iron_Likert_df <- as.data.frame(Perception_Iron_Likert)
columns_to_transform <- c("I would gladly make use of this", "I would have a positive attitude towards this", "I think it is important that a physician is involved", "I think it is important that my iron levels are monitored more often", "This would have a negative effect on my motivation to donate", "I would find this pushy", "I think too much is being asked of donors", "I would like to receive more information about this first", "I would prefer this over deferral") 
for (col in columns_to_transform) {
  Perception_Iron_Likert_df[[col]] <- factor(Perception_Iron_Likert_df[[col]],
                                         levels = c("1", "2", "3", "4", "5"),
                                         ordered = TRUE)
}

Likert_Perception = likert(Perception_Iron_Likert_df)


# Create the heatmap plot
plot(Likert_Perception,
     type = "heat",
     low.color = "white",
     high.color = "purple",
     text.color = "black",
     text.size = 3,
     wrap = 70)

FileName <- paste(FolderName, "/Heatmap - Perception Iron Supplementation.png",sep="")
ggsave(FileName, width = 18, height = 10)


# Create percentage plot
plot(Likert_Perception,
     text.size = 3,
     wrap = 40, 
     cex.names = 12)

FileName <- paste(FolderName, "/Proportions - Perception Iron Supplementation.png",sep="")
ggsave(FileName, width = 8, height = 5)



# HEATMAP - Men
Perception_Iron_Likert_M <- Willingness_Iron_M %>% select(-Sex)
Perception_Iron_Likert_df_M <- as.data.frame(Perception_Iron_Likert_M)
columns_to_transform <- c("I would gladly make use of this", "I would have a positive attitude towards this", "I think it is important that a physician is involved", "I think it is important that my iron levels are monitored more often", "This would have a negative effect on my motivation to donate", "I would find this pushy", "I think too much is being asked of donors", "I would like to receive more information about this first", "I would prefer this over deferral") 
for (col in columns_to_transform) {
  Perception_Iron_Likert_df_M[[col]] <- factor(Perception_Iron_Likert_df_M[[col]],
                                         levels = c("1", "2", "3", "4", "5"),
                                         ordered = TRUE)
}

Likert_Perception_M = likert(Perception_Iron_Likert_df_M)

plot(Likert_Perception_M,
     type="heat",
           low.color = "white",
           high.color = "purple",
           text.color = "black",
           text.size = 3,
           wrap = 70)

FileName <- paste(FolderName, "/Heatmap - Perception Iron Supplementation - Men.png",sep="")
ggsave(FileName, width = 18, height = 10)



# HEATMAP - Women
Perception_Iron_Likert_W <- Willingness_Iron_W %>% select(-Sex)
Perception_Iron_Likert_df_W <- as.data.frame(Perception_Iron_Likert_W)
columns_to_transform <- c("I would gladly make use of this", "I would have a positive attitude towards this", "I think it is important that a physician is involved", "I think it is important that my iron levels are monitored more often", "This would have a negative effect on my motivation to donate", "I would find this pushy", "I think too much is being asked of donors", "I would like to receive more information about this first", "I would prefer this over deferral") 
for (col in columns_to_transform) {
  Perception_Iron_Likert_df_W[[col]] <- factor(Perception_Iron_Likert_df_W[[col]],
                                         levels = c("1", "2", "3", "4", "5"),
                                         ordered = TRUE)
}

Likert_Perception_W = likert(Perception_Iron_Likert_df_W)

plot(Likert_Perception_W,
     type="heat",
           low.color = "white",
           high.color = "purple",
           text.color = "black",
           text.size = 3,
           wrap = 70)

FileName <- paste(FolderName, "/Heatmap - Perception Iron Supplementation - Women.png",sep="")
ggsave(FileName, width = 18, height = 10)
```



## Reasons To Provide Iron Supplementation To Donors

```{r}
# Bar graph
IronSupp_Reason <- Data[,c(4, 181:185)]
names(IronSupp_Reason)[names(IronSupp_Reason) == "IronSuppSanqReason1"] <- "To prevend extended donation intervals"
names(IronSupp_Reason)[names(IronSupp_Reason) == "IronSuppSanqReason2"] <- "When used by other international blood services"
names(IronSupp_Reason)[names(IronSupp_Reason) == "IronSuppSanqReason3"] <- "To help donors maintain their health"
names(IronSupp_Reason)[names(IronSupp_Reason) == "IronSuppSanqReason4"] <- "If supported by scientific evidence"
names(IronSupp_Reason)[names(IronSupp_Reason) == "IronSuppSanqReason5"] <- "Should never by considered as a policy"

## Drop rows with missings
colSums(is.na(IronSupp_Reason)) # 83 in total (<10%)
IronSupp_Reason <- IronSupp_Reason %>% drop_na()

# Create datasets for men and women 
IronSupp_Reason_M <- IronSupp_Reason %>% filter(Sex == "Men")
IronSupp_Reason_W <- IronSupp_Reason %>% filter(Sex == "Women")

# LIKERT Figure - Complete
IronSupp_Reason <- IronSupp_Reason %>% select(-Sex)
IronSupp_Reason_Likert_df <- as.data.frame(IronSupp_Reason)
columns_to_transform <- c("To prevend extended donation intervals", "When used by other international blood services", "To help donors maintain their health", "If supported by scientific evidence", "Should never by considered as a policy")  # Add all column names here
for (col in columns_to_transform) {
  IronSupp_Reason_Likert_df[[col]] <- factor(IronSupp_Reason_Likert_df[[col]],
                                         levels = c("1", "2", "3", "4", "5"),
                                         ordered = TRUE)
}

# Definieer de functie om waarden om te zetten
convert_values <- function(x) {
  factor(6 - as.numeric(x), levels = 1:5, ordered = TRUE)
}

# Pas de functie toe op alle variabelen in de dataset
IronSupp_Reason_Likert_df <- IronSupp_Reason_Likert_df %>%
  mutate_all(convert_values)

Likert_Reason_IronSupp = likert(IronSupp_Reason_Likert_df)

# Create percentage plot
plot(Likert_Reason_IronSupp,
     text.size = 3,
     wrap = 50, 
     cex.names = 12)


FileName <- paste(FolderName, "/Proportions - Reasons For Using Iron Supplements.png",sep="")
ggsave(FileName, width = 8, height = 5)


# HEATMAP - Men
IronSupp_Reason_Likert_M <- IronSupp_Reason_M %>% select(-Sex)
IronSupp_Reason_Likert_df_M <- as.data.frame(IronSupp_Reason_Likert_M)
columns_to_transform <- c("To prevend extended donation intervals", "When used by other international blood services", "To help donors maintain their health", "If supported by scientific evidence", "Should never by considered as a policy")  # Add all column names here
for (col in columns_to_transform) {
  IronSupp_Reason_Likert_df_M[[col]] <- factor(IronSupp_Reason_Likert_df_M[[col]],
                                         levels = c("1", "2", "3", "4", "5"),
                                         ordered = TRUE)
}

# Definieer de functie om waarden om te zetten
convert_values <- function(x) {
  factor(6 - as.numeric(x), levels = 1:5, ordered = TRUE)
}

# Pas de functie toe op alle variabelen in de dataset
IronSupp_Reason_Likert_df_M <- IronSupp_Reason_Likert_df_M %>%
  mutate_all(convert_values)

Likert_Reason_IronSupp_M = likert(IronSupp_Reason_Likert_df_M)

plot(Likert_Reason_IronSupp_M,
     type="heat",
           low.color = "white",
           high.color = "purple",
           text.color = "black",
           text.size = 3,
           wrap = 50)

FileName <- paste(FolderName, "/Heatmap - Reasons For Using Iron Supplements - Men.png",sep="")
ggsave(FileName, width = 15, height = 10)


# HEATMAP - Women
IronSupp_Reason_Likert_W <- IronSupp_Reason_W %>% select(-Sex)
IronSupp_Reason_Likert_df_W <- as.data.frame(IronSupp_Reason_Likert_W)
columns_to_transform <- c("To prevend extended donation intervals", "When used by other international blood services", "To help donors maintain their health", "If supported by scientific evidence", "Should never by considered as a policy")  # Add all column names here
for (col in columns_to_transform) {
  IronSupp_Reason_Likert_df_W[[col]] <- factor(IronSupp_Reason_Likert_df_W[[col]],
                                         levels = c("1", "2", "3", "4", "5"),
                                         ordered = TRUE)
}

# Definieer de functie om waarden om te zetten
convert_values <- function(x) {
  factor(6 - as.numeric(x), levels = 1:5, ordered = TRUE)
}

# Pas de functie toe op alle variabelen in de dataset
IronSupp_Reason_Likert_df_W <- IronSupp_Reason_Likert_df_W %>%
  mutate_all(convert_values)

Likert_Reason_IronSupp_W = likert(IronSupp_Reason_Likert_df_W)

plot(Likert_Reason_IronSupp_W,
     type="heat",
           low.color = "white",
           high.color = "purple",
           text.color = "black",
           text.size = 3,
           wrap = 50)

FileName <- paste(FolderName, "/Heatmap - Reasons For Using Iron Supplements - Women.png",sep="")
ggsave(FileName, width = 15, height = 10)
```

## Prefered consequence low iron levels

```{r}
## Preparation
Pref_LowIron <- Data[,c(4, 171:174)]
names(Pref_LowIron)[names(Pref_LowIron) == "IronDefPref1"] <- "Longer donation intervals"
names(Pref_LowIron)[names(Pref_LowIron) == "IronDefPref2"] <- "Ferritin guided deferral with dietary advice"
names(Pref_LowIron)[names(Pref_LowIron) == "IronDefPref3"] <- "Iron supplementation without deferral"
names(Pref_LowIron)[names(Pref_LowIron) == "IronDefPref4"] <- "Stop donating completely"

## Drop rows with missings
colSums(is.na(Pref_LowIron)) # 54 in total (<10%)
Pref_LowIron <- Pref_LowIron %>% drop_na()

# Create datasets for men and women 
Pref_LowIron_M <- Pref_LowIron %>% filter(Sex == "Men")
Pref_LowIron_W <- Pref_LowIron %>% filter(Sex == "Women")

# HEATMAP - Complete
Pref_LowIron_Likert <- Pref_LowIron %>% select(-Sex)
Pref_LowIron_Likert_df <- as.data.frame(Pref_LowIron_Likert)
columns_to_transform <- c("Longer donation intervals", "Ferritin guided deferral with dietary advice", "Iron supplementation without deferral", "Stop donating completely")  # Add all column names here
for (col in columns_to_transform) {
  Pref_LowIron_Likert_df[[col]] <- factor(Pref_LowIron_Likert_df[[col]],
                                         levels = c("1", "2", "3", "4"),
                                         ordered = TRUE)
}

# Recode values
convert_values <- function(x) {
  factor(5 - as.numeric(x), levels = 1:4, ordered = TRUE)
}
Pref_LowIron_Likert_df <- Pref_LowIron_Likert_df %>%
  mutate_all(convert_values)

# Adjust dataset to likert data
Likert_Pref_LowIron = likert(Pref_LowIron_Likert_df)

# plot Heatmap
plot(Likert_Pref_LowIron,
     type = "heat",
     low.color = "white",
     high.color = "purple",
     text.color = "black",
     text.size = 3,
     wrap = 50
)

FileName <- paste(FolderName, "/Heatmap - Preference low ferritin.png",sep="")
ggsave(FileName, width = 8, height = 4)

# Create Likert percentage plot
plot(Likert_Pref_LowIron,
     text.size = 3,
     wrap = 45, 
     cex.names = 12)

FileName <- paste(FolderName, "/Proportions - Preference low ferritin.png",sep="")
ggsave(FileName, width = 8, height = 5)


# HEATMAP - Men
Pref_LowIron_Likert_M <- Pref_LowIron_M %>% select(-Sex)
Pref_LowIron_Likert_df_M <- as.data.frame(Pref_LowIron_Likert_M)
columns_to_transform <- c("Longer donation intervals", "Ferritin guided deferral with dietary advice", "Iron supplementation without deferral", "Stop donating completely")  # Add all column names here
for (col in columns_to_transform) {
  Pref_LowIron_Likert_df_M[[col]] <- factor(Pref_LowIron_Likert_df_M[[col]],
                                         levels = c("1", "2", "3", "4"),
                                         ordered = TRUE)
}

# Recode values
convert_values <- function(x) {
  factor(5 - as.numeric(x), levels = 1:4, ordered = TRUE)
}
Pref_LowIron_Likert_df_M <- Pref_LowIron_Likert_df_M %>%
  mutate_all(convert_values)

# Adjust dataset to likert data
Likert_Pref_LowIron_M = likert(Pref_LowIron_Likert_df_M)

# plot Heatmap
plot(Likert_Pref_LowIron_M,
     type = "heat",
     low.color = "white",
     high.color = "purple",
     text.color = "black",
     text.size = 3,
     wrap = 50
)

FileName <- paste(FolderName, "/Heatmap - Preference low ferritin - Men.png",sep="")
ggsave(FileName, width = 8, height = 4)

# HEATMAP - Women
Pref_LowIron_Likert_W <- Pref_LowIron_W %>% select(-Sex)
Pref_LowIron_Likert_df_W <- as.data.frame(Pref_LowIron_Likert_W)
columns_to_transform <- c("Longer donation intervals", "Ferritin guided deferral with dietary advice", "Iron supplementation without deferral", "Stop donating completely")  # Add all column names here
for (col in columns_to_transform) {
  Pref_LowIron_Likert_df_W[[col]] <- factor(Pref_LowIron_Likert_df_W[[col]],
                                         levels = c("1", "2", "3", "4"),
                                         ordered = TRUE)
}

# Recode values
convert_values <- function(x) {
  factor(5 - as.numeric(x), levels = 1:4, ordered = TRUE)
}
Pref_LowIron_Likert_df_W <- Pref_LowIron_Likert_df_W %>%
  mutate_all(convert_values)

# Adjust dataset to likert data
Likert_Pref_LowIron_W = likert(Pref_LowIron_Likert_df_W)

# plot Heatmap
plot(Likert_Pref_LowIron_W,
     type = "heat",
     low.color = "white",
     high.color = "purple",
     text.color = "black",
     text.size = 3,
     wrap = 50
)

FileName <- paste(FolderName, "/Heatmap - Preference low ferritin - Women.png",sep="")
ggsave(FileName, width = 8, height = 4)
```



# Conditions for use iron supplements
# Under what circumstances would you be willing to use iron supplements

```{r}
Conditions <- Data[,c(4,175:180)]
names(Conditions)[names(Conditions) == "IronSuppSanqCondition1"] <- "To treat symptoms"
names(Conditions)[names(Conditions) == "IronSuppSanqCondition2"] <- "To prevent symptoms"
names(Conditions)[names(Conditions) == "IronSuppSanqCondition3"] <- "To continue donating regularly"
names(Conditions)[names(Conditions) == "IronSuppSanqCondition4"] <- "When advised by donor physician"
names(Conditions)[names(Conditions) == "IronSuppSanqCondition5"] <- "When supported by scientific evidence"
names(Conditions)[names(Conditions) == "IronSuppSanqCondition6"] <- "Never willing to use iron supplements"

colSums(is.na(Conditions))

## Drop rows with missings
Conditions <- Conditions %>% drop_na()

# Bar-graph
Conditions.long <- tidyr::gather(Conditions, key = type_col, value = categories, -Sex)
Conditions.long$categories <- as.factor(Conditions.long$categories)
Conditions.long$categories <- gsub("1", "Yes", Conditions.long$categories)
Conditions.long$categories <- gsub("2", "No", Conditions.long$categories)
Conditions.long$type_col <- factor(Conditions.long$type_col, levels=c('To treat symptoms','When supported by scientific evidence','When advised by donor physician','To prevent symptoms', 'To continue donating regularly', 'Never willing to use iron supplements'))


ggplot(Conditions.long, aes(x = type_col, fill = categories)) +
  geom_bar(position = position_stack()) + theme(text = element_text(size = 15))+ 
geom_text(stat='count', aes(label=..count..), position = position_stack(vjust = 0.6))+
    scale_fill_brewer(palette="Greens")  +
        theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8), axis.text.y.left = element_text(size = 8),axis.title.y = element_text(vjust = 3, size = 14), legend.text = element_text(size=12))+
  xlab("") + ylab("Frequency")+ guides(fill=guide_legend(title=""))

FileName <- paste(FolderName, "/Circumstances iron suppl use.png",sep="")
ggsave(FileName, width = 10, height = 8)

# Summary
table(Conditions.long$type_col, Conditions.long$categories)
table(Conditions.long$type_col, Conditions.long$categories, Conditions.long$Sex)


# Proportions figure
ConditionsFig <- Conditions.long %>%
  group_by(type_col, categories) %>%
  summarise(total_count = n())

# Calculate proportions
ConditionsFig <- ConditionsFig %>%
  group_by(type_col) %>% 
  mutate(proportion = total_count / sum(total_count))

ConditionsFig <- ConditionsFig %>% ungroup()

# Plot the stacked bar plot with proportions
ggplot(ConditionsFig, aes(y = type_col, fill = categories)) +
  geom_bar(position = "stack", aes(weight = proportion)) +
  theme_classic() +  # Set the overall theme
  theme(
    text = element_text(size = 12),
    plot.background = element_rect(fill = "white"),  # Set the background color to white
    axis.text.y = element_text(angle = 0, hjust = 1, size = 8),
    axis.text.x.bottom = element_text(size = 8),
    axis.title.x = element_text(vjust = -2, size = 10),
    legend.text = element_text(size = 8),
    legend.position = "bottom"
  ) +
  guides(fill = guide_legend(title = " ", reverse = TRUE))+
  scale_fill_brewer(palette = "Purples") +
  scale_y_discrete(labels = function(y) stringr::str_wrap(y, width = 60)) +
  ylab("") +
  xlab("Proportion") 

FileName <- paste(FolderName, "/Proportions - Circumstances iron suppl use (proportion).png",sep="")
ggsave(FileName, width = 6, height = 4)







# HEATMAP - Complete
Conditions_Likert <- Conditions %>% select(-Sex)
Conditions_Likert_df <- as.data.frame(Conditions_Likert)
columns_to_transform <- c("To treat symptoms", "To prevent symptoms", "To continue donating regularly", "When advised by donor physician", "When supported by scientific evidence", "Never willing to use iron supplements")  

# Add all column names here
for (col in columns_to_transform) {
  Conditions_Likert_df[[col]] <- factor(Conditions_Likert_df[[col]],
                                         levels = c("1", "2"),
                                         ordered = TRUE)
}

# Recode values
convert_values <- function(x) {
  factor(3 - as.numeric(x), levels = 1:2, ordered = TRUE)
}
Conditions_Likert_df <- Conditions_Likert_df %>%
  mutate_all(convert_values)

# Adjust dataset to likert data
Likert_Conditions = likert(Conditions_Likert_df)

# Create Likert percentage plot
plot(Likert_Conditions,
     text.size = 3,
     wrap = 45, 
     cex.names = 12)

FileName <- paste(FolderName, "/Proportions - Preference low ferritin.png",sep="")
ggsave(FileName, width = 8, height = 5)
```



# Knowledge #

# Knowledge policy frequencies

```{r}

# Knowledge level variables selection
KnowledgePolicy <- Data[,c(3,4,8,46,54,59:63,191:193)]
#KnowledgePolicy[,6:10][KnowledgePolicy[,6:10] < 0] <- 0 
KnowledgePolicy$KnowledgePolicySum = rowSums(KnowledgePolicy[ , c("KnowledgeHb4","KnowledgeFer4","MeasurementSum","HbConsequence","FerConsequence")], na.rm = T)

apply(KnowledgePolicy[-1], 2, table)

# Plot outcomes
# Select variables of interst
KnowledgePolicyLong <- tidyr::gather(KnowledgePolicy[,c(2,4,5,6:10,12,13)], key = type_col, value = categories, -Sex)

# Adjust measurement 2,4, and 5 to be able to apply the correct/incorrect recoding (this must be done after the sum score)
KnowledgePolicyLong <- KnowledgePolicyLong %>%
  mutate(
    categories = ifelse(type_col == "Measurement2" & categories == 0, 1.5, categories),
    categories = ifelse(type_col == "Measurement4" & categories == 0, 1.5, categories),
    categories = ifelse(type_col == "Measurement5" & categories == 0, 1.5, categories)
  )

# Create factor for correct and incorrect
KnowledgePolicyLong <- KnowledgePolicyLong %>% drop_na()
KnowledgePolicyLong$categories <- gsub(0, "Incorrect", KnowledgePolicyLong$categories)
KnowledgePolicyLong$categories <- gsub(-1, "Incorrect", KnowledgePolicyLong$categories)
KnowledgePolicyLong$categories <- gsub(1.5, "Correct", KnowledgePolicyLong$categories)
KnowledgePolicyLong$categories <- gsub(1, "Correct", KnowledgePolicyLong$categories)
KnowledgePolicyLong$categories <- as.factor(KnowledgePolicyLong$categories)

# Adjust names
KnowledgePolicyLong <- KnowledgePolicyLong%>%
    mutate(type = case_when(
    type_col == "Measurement1" ~ "Sanquin measures Hb",
    type_col == "Measurement2" ~ "Sanquin measures transferrin",
    type_col == "Measurement3" ~ "Sanquin measures ferritin",
    type_col == "Measurement4" ~ "Sanquin measures hepcidin",
    type_col == "Measurement5" ~ "Sanquin measures dopamin",
    type_col == "KnowledgeHb4" ~ "Hb is measured during every donation",
    type_col == "HbConsequence" ~ "What is the consequence of low Hb",
    type_col == "KnowledgeFer4" ~ "Ferritin is measured during every donation",
    type_col == "FerConsequence" ~ "What is the consequence of low ferritin"))

# Order variable
KnowledgePolicyLong$type <- factor(KnowledgePolicyLong$type, levels=c("Sanquin measures Hb","Sanquin measures transferrin", "Sanquin measures ferritin", "Sanquin measures hepcidin", "Sanquin measures dopamin","Hb is measured during every donation", "Ferritin is measured during every donation","What is the consequence of low Hb", "What is the consequence of low ferritin"))
KnowledgePolicyLong$type <- factor(KnowledgePolicyLong$type, levels = rev(unique(KnowledgePolicyLong$type)))

# Recode to factor
KnowledgePolicyLong$categories <- factor(KnowledgePolicyLong$categories, levels=c('Incorrect','Correct'))

# Proportions table
proportion_table <- KnowledgePolicyLong %>%
  group_by(type) %>%
  summarise(
    Correct = sum(categories == "Correct"),
    Proportion = sum(categories == "Correct") / n()
  )
print(proportion_table)

# Plot stackd bargraph
ggplot(KnowledgePolicyLong, aes(y = reorder(type, -as.numeric(type)), fill = categories)) +
  geom_bar(position = "stack") +
  theme(text = element_text(size = 15)) +
  geom_text(stat = "count", aes(label = after_stat(count)), position = position_stack(vjust = 0.6)) +
  scale_fill_brewer(palette = "Purples")+
  scale_y_discrete(labels = function(y) stringr::str_wrap(y, width = 60)) +
  theme(
    axis.text.y = element_text(angle = 0, hjust = 1, size = 8),
    axis.text.x.bottom = element_text(size = 8),
    axis.title.x = element_text(vjust = -2, size = 14),
    legend.text = element_text(size = 12)
  ) + ylab("") + xlab("Frequency") + guides(fill = guide_legend(title = " ")) +
  theme_classic()+
  theme(legend.position = "bottom") 

FileName <- paste(FolderName, "/Knowledge policy (Count).png",sep="")
ggsave(FileName, width = 10, height = 4)

# proportions
KnowledgePolicyFig <- KnowledgePolicyLong %>%
  group_by(type, categories) %>%
  summarise(total_count = n())

# Calculate proportions
KnowledgePolicyFig <- KnowledgePolicyFig %>%
  group_by(type) %>% 
  mutate(proportion = total_count / sum(total_count))

KnowledgePolicyFig <- KnowledgePolicyFig %>% ungroup()

# Plot the stacked bar plot with proportions
ggplot(KnowledgePolicyFig, aes(y = reorder(type, -as.numeric(type)), fill = categories)) +
  geom_bar(position = "stack", aes(weight = proportion)) +
  theme_classic() +  # Set the overall theme
  theme(
    text = element_text(size = 15),
    plot.background = element_rect(fill = "white"),  # Set the background color to white
    axis.text.y = element_text(angle = 0, hjust = 1, size = 8),
    axis.text.x.bottom = element_text(size = 8),
    axis.title.x = element_text(vjust = -2, size = 14),
    legend.text = element_text(size = 12),
    legend.position = "bottom"
  ) +
  scale_fill_brewer(palette = "Purples") +
  scale_y_discrete(labels = function(y) stringr::str_wrap(y, width = 60)) +
  ylab("") +
  xlab("Proportion") +
  guides(fill = guide_legend(title = " ", reverse = TRUE))


FileName <- paste(FolderName, "/Knowledge policy (Proportion).png",sep="")
ggsave(FileName, width = 10, height = 4)




```

# Knowledge iron metabolism frequencies
```{r}
# Knowledge level variables selection
KnowledgeIronMetabolism <- Data[,c(3,4,8,38,43:45,51:53,92:100)]
KnowledgeIronMet <- KnowledgeIronMetabolism[,-c(11:19)]

apply(KnowledgeIronMet[-1], 2, table)

## Plot outcomes
# Select variables of interst
KnowledgeIronMetaLong <- tidyr::gather(KnowledgeIronMet[,c(2,4:10)], key = type_col, value = categories, -Sex)

KnowledgeIronMetaLong <- KnowledgeIronMetaLong%>%
    mutate(type = case_when(
    type_col == "Knowledge4" ~ "A donor loses iron during donation",
    type_col == "KnowledgeHb1" ~ "Hb is involved in blood clothing",
    type_col == "KnowledgeHb2" ~ "Hb transports oxygen through the body",
    type_col == "KnowledgeHb3" ~ "Hb is a measure for the iron store",
    type_col == "KnowledgeFer1" ~ "Ferritin is important for Hb synthesis",
    type_col == "KnowledgeFer2" ~ "Ferritin transports oxygen through the body",
    type_col == "KnowledgeFer3" ~ "Ferritin is a measure for the iron store"))

# Create factor for correct and incorrect
KnowledgeIronMetaLong <- KnowledgeIronMetaLong %>% drop_na()
KnowledgeIronMetaLong$categories <- gsub(0, "Incorrect", KnowledgeIronMetaLong$categories)
KnowledgeIronMetaLong$categories <- gsub(1, "Correct", KnowledgeIronMetaLong$categories)
KnowledgeIronMetaLong$categories <- as.factor(KnowledgeIronMetaLong$categories)

KnowledgeIronMetaLong$categories <- factor(KnowledgeIronMetaLong$categories, levels=c('Incorrect','Correct'))

# Proportions table
proportion_table <- KnowledgeIronMetaLong %>%
  group_by(type) %>%
  summarise(
    Correct = sum(categories == "Correct"),
    Proportion = sum(categories == "Correct") / n()
  )
print(proportion_table)

# Plot outcomes
ggplot(KnowledgeIronMetaLong, aes(y = type, fill = categories)) +
  geom_bar(position = "stack") +
  theme(text = element_text(size = 15)) +
  geom_text(stat = "count", aes(label = after_stat(count)), position = position_stack(vjust = 0.6)) +
  scale_fill_brewer(palette = "Purples") +
  scale_y_discrete(labels = function(y) stringr::str_wrap(y, width = 60)) +
  theme(
    axis.text.y = element_text(angle = 0, hjust = 1, size = 8),
    axis.text.x.bottom = element_text(size = 8),
    axis.title.x = element_text(vjust = -2, size = 14),
    legend.text = element_text(size = 12)
  ) + ylab("") + xlab("Frequency") + guides(fill = guide_legend(title = " ")) +
  theme_classic()+
  theme(legend.position = "bottom") 

FileName <- paste(FolderName, "/Knowledge iron metabolism (Count).png",sep="")
ggsave(FileName, width = 12, height = 5)




# proportions
KnowledgeIronMetaFig <- KnowledgeIronMetaLong %>%
  group_by(type, categories) %>%
  summarise(total_count = n())

# Calculate proportions
KnowledgeIronMetaFig <- KnowledgeIronMetaFig %>%
  group_by(type) %>% 
  mutate(proportion = total_count / sum(total_count))

KnowledgeIronMetaFig <- KnowledgeIronMetaFig %>% ungroup()

# Plot the stacked bar plot with proportions
ggplot(KnowledgeIronMetaFig, aes(y = reorder(type, -as.numeric(type)), fill = categories)) +
  geom_bar(position = "stack", aes(weight = proportion)) +
  theme_classic() +  # Set the overall theme
  theme(
    text = element_text(size = 15),
    plot.background = element_rect(fill = "white"),  # Set the background color to white
    axis.text.y = element_text(angle = 0, hjust = 1, size = 8),
    axis.text.x.bottom = element_text(size = 8),
    axis.title.x = element_text(vjust = -2, size = 14),
    legend.text = element_text(size = 12),
    legend.position = "bottom"
  ) +
  scale_fill_brewer(palette = "Purples") +
  scale_y_discrete(labels = function(y) stringr::str_wrap(y, width = 60)) +
  ylab("") +
  xlab("Proportion") +
  guides(fill = guide_legend(title = " ", reverse = TRUE))


FileName <- paste(FolderName, "/Knowledge Iron Metabolism (Proportion).png",sep="")
ggsave(FileName, width = 10, height = 4)

```


# Iron deficiency symptoms frequencies

```{r}
# Select variables
SymptomsIronDef <- KnowledgeIronMetabolism[,c(2,11:16)]
SymptomsIronDef <- SymptomsIronDef[,-(6)]

# Recode correct answers 
SymptomsIronDef$SymptomsIron2 <- gsub(0, "1", SymptomsIronDef$SymptomsIron2)
SymptomsIronDef$SymptomsIron4 <- gsub(0, "1", SymptomsIronDef$SymptomsIron4)


SymptomsIronDefLong <- tidyr::gather(SymptomsIronDef, key = type_col, value = categories, -Sex)
SymptomsIronDefLong$categories[SymptomsIronDefLong$categories < 0] <- 0 
SymptomsIronDefLong <- SymptomsIronDefLong%>%
    mutate(type = case_when(
    type_col == "SymptomsIron1" ~ "Restless legs syndrome",
    type_col == "SymptomsIron2" ~ "Dark stool",
    type_col == "SymptomsIron3" ~ "Fatigue",
    type_col == "SymptomsIron4" ~ "Gastrointestinal complaints",
    type_col == "SymptomsIron6" ~ "Headache"))

# Create factor for correct and incorrect
SymptomsIronDefLong <- SymptomsIronDefLong %>% drop_na()
SymptomsIronDefLong$categories <- gsub(0, "Incorrect", SymptomsIronDefLong$categories)
SymptomsIronDefLong$categories <- gsub(1, "Correct", SymptomsIronDefLong$categories)
SymptomsIronDefLong$categories <- as.factor(SymptomsIronDefLong$categories)

SymptomsIronDefLong$categories <- factor(SymptomsIronDefLong$categories, levels=c('Incorrect','Correct'))
SymptomsIronDefLong$type <- factor(SymptomsIronDefLong$type, levels=c('Restless legs syndrome','Headache','Fatigue','Dark stool','Gastrointestinal complaints'))

# Proportions table
proportion_table <- SymptomsIronDefLong %>%
  group_by(type) %>%
  summarise(
    Correct = sum(categories == "Correct"),
    Proportion = sum(categories == "Correct") / n()
  )
print(proportion_table)


SymptomsIronDefLong <- SymptomsIronDefLong %>% ungroup()

# Plot outcomes
ggplot(SymptomsIronDefLong, aes(y = type, fill = rev(categories))) +
  geom_bar(position = "stack") +
  theme(text = element_text(size = 15)) +
  geom_text(stat = "count", aes(label = after_stat(count)), position = position_stack(vjust = 0.6)) +
  scale_fill_brewer(palette = "Purples") +
  scale_y_discrete(labels = function(y) stringr::str_wrap(y, width = 60)) +
  theme(
    axis.text.y = element_text(angle = 0, hjust = 1, size = 8),
    axis.text.x.bottom = element_text(size = 8),
    axis.title.x = element_text(vjust = -2, size = 14),
    legend.text = element_text(size = 12)
  ) + ylab("") + xlab("Frequency") + guides(fill = guide_legend(title = " ", reverse = TRUE)) +
  theme_classic()+
  theme(legend.position = "bottom") 

FileName <- paste(FolderName, "/Knowledge iron deficiency symptoms (Count).png",sep="")
ggsave(FileName, width = 12, height = 5)




# proportions
SymptomsIronDefFig <- SymptomsIronDefLong %>%
  group_by(type, categories) %>%
  summarise(total_count = n())

# Calculate proportions
SymptomsIronDefFig <- SymptomsIronDefFig %>%
  group_by(type) %>% 
  mutate(proportion = total_count / sum(total_count))

SymptomsIronDefFig <- SymptomsIronDefFig %>% ungroup()

# Plot the stacked bar plot with proportions
ggplot(SymptomsIronDefFig, aes(y = reorder(type, -as.numeric(type)), fill = categories)) +
  geom_bar(position = "stack", aes(weight = proportion)) +
  theme_classic() +  # Set the overall theme
  theme(
    text = element_text(size = 15),
    plot.background = element_rect(fill = "white"),  # Set the background color to white
    axis.text.y = element_text(angle = 0, hjust = 1, size = 8),
    axis.text.x.bottom = element_text(size = 8),
    axis.title.x = element_text(vjust = -2, size = 14),
    legend.text = element_text(size = 12),
    legend.position = "bottom"
  ) +
  scale_fill_brewer(palette = "Purples") +
  scale_y_discrete(labels = function(y) stringr::str_wrap(y, width = 60)) +
  ylab("") +
  xlab("Proportion") +
  guides(fill = guide_legend(title = " ", reverse = TRUE))


FileName <- paste(FolderName, "/Knowledge iron deficiency symptoms (Proportion).png",sep="")
ggsave(FileName, width = 10, height = 4)
```


# Knowledge iron supplements frequencies

```{r}
# Knowledge level variables selection
KnowledgeIronSuppl <- Data[,c(3,4,8,135:138,143:151)]
KnowledgeIronSuppl <- KnowledgeIronSuppl[,-c(12,14:16)]


apply(KnowledgeIronSuppl[-1], 2, table)

# Plot outcomes
# Select variables of interst
KnowledgeIronSuppLong <- tidyr::gather(KnowledgeIronSuppl[,c(2,4:7)], key = type_col, value = categories, -Sex)

KnowledgeIronSuppLong <- KnowledgeIronSuppLong%>%
    mutate(type = case_when(
    type_col == "IronSuppKnowledge1" ~ "Iron supplements are provided by Sanquin",
    type_col == "IronSuppKnowledge2" ~ "Iron supplements can improve post-donation iron store recovery",
    type_col == "IronSuppKnowledge3" ~ "Iron supplements are only available through prescription",
    type_col == "IronSuppKnowledge4" ~ "Iron supplements can lead to side effects"))

# Create factor for correct and incorrect
KnowledgeIronSuppLong <- KnowledgeIronSuppLong %>% drop_na()
KnowledgeIronSuppLong$categories <- gsub(0, "Incorrect", KnowledgeIronSuppLong$categories)
KnowledgeIronSuppLong$categories <- gsub(1, "Correct", KnowledgeIronSuppLong$categories)
KnowledgeIronSuppLong$categories <- as.factor(KnowledgeIronSuppLong$categories)

KnowledgeIronSuppLong$categories <- factor(KnowledgeIronSuppLong$categories, levels=c('Incorrect','Correct'))

# Proportions table
proportion_table <- KnowledgeIronSuppLong %>%
  group_by(type) %>%
  summarise(
    Correct = sum(categories == "Correct"),
    Proportion = sum(categories == "Correct") / n())
print(proportion_table)

# Plot outcomes
ggplot(KnowledgeIronSuppLong, aes(y = type, fill = categories)) +
  geom_bar(position = "stack") +
  theme(text = element_text(size = 15)) +
  geom_text(stat = "count", aes(label = after_stat(count)), position = position_stack(vjust = 0.6)) +
  scale_fill_brewer(palette = "Purples") +
  scale_y_discrete(labels = function(y) stringr::str_wrap(y, width = 35)) +
  theme(
    axis.text.y = element_text(angle = 0, hjust = 1, size = 8),
    axis.text.x.bottom = element_text(size = 8),
    axis.title.x = element_text(vjust = -2, size = 14),
    legend.text = element_text(size = 12)
  ) + ylab("") + xlab("Frequency") + guides(fill = guide_legend(title = " ")) +
  theme_classic()+
  theme(legend.position = "bottom") 

FileName <- paste(FolderName, "/Knowledge iron supplements (Count).png",sep="")
ggsave(FileName, width = 12, height = 5)




# proportions
KnowledgeIronSuppFig <- KnowledgeIronSuppLong %>%
  group_by(type, categories) %>%
  summarise(total_count = n())

# Calculate proportions
KnowledgeIronSuppFig <- KnowledgeIronSuppFig %>%
  group_by(type) %>% 
  mutate(proportion = total_count / sum(total_count))

KnowledgeIronSuppFig <- KnowledgeIronSuppFig %>% ungroup()

# Plot the stacked bar plot with proportions
ggplot(KnowledgeIronSuppFig, aes(y = reorder(type, -as.numeric(type)), fill = categories)) +
  geom_bar(position = "stack", aes(weight = proportion)) +
  theme_classic() +  # Set the overall theme
  theme(
    text = element_text(size = 15),
    plot.background = element_rect(fill = "white"),  # Set the background color to white
    axis.text.y = element_text(angle = 0, hjust = 1, size = 8),
    axis.text.x.bottom = element_text(size = 8),
    axis.title.x = element_text(vjust = -2, size = 14),
    legend.text = element_text(size = 12),
    legend.position = "bottom"
  ) +
  scale_fill_brewer(palette = "Purples") +
  scale_y_discrete(labels = function(y) stringr::str_wrap(y, width = 60)) +
  ylab("") +
  xlab("Proportion") +
  guides(fill = guide_legend(title = " ", reverse = TRUE))


FileName <- paste(FolderName, "/Knowledge iron supplements (Proportion).png",sep="")
ggsave(FileName, width = 10, height = 4)

```


# Iron Supplementation side effects frequencies

```{r}
# Select variables
SymptomsIronSupp <- KnowledgeIronSuppl[,c(2,8:12)]


# Recode correct answers 
SymptomsIronSupp$IronSuppSE1 <- gsub(0, "1", SymptomsIronSupp$IronSuppSE1)
SymptomsIronSupp$IronSuppSE3 <- gsub(0, "1", SymptomsIronSupp$IronSuppSE3)


SymptomsIronSuppLong <- tidyr::gather(SymptomsIronSupp, key = type_col, value = categories, -Sex)
SymptomsIronSuppLong$categories[SymptomsIronSuppLong$categories < 0] <- 0 
SymptomsIronSuppLong <- SymptomsIronSuppLong%>%
    mutate(type = case_when(
    type_col == "IronSuppSE1" ~ "Restless legs syndrome",
    type_col == "IronSuppSE2" ~ "Dark stool",
    type_col == "IronSuppSE3" ~ "Fatigue",
    type_col == "IronSuppSE4" ~ "Gastrointestinal complaints",
    type_col == "IronSuppSE6" ~ "Headache"))

# Create factor for correct and incorrect
SymptomsIronSuppLong <- SymptomsIronSuppLong %>% drop_na()
SymptomsIronSuppLong$categories <- gsub(0, "Incorrect", SymptomsIronSuppLong$categories)
SymptomsIronSuppLong$categories <- gsub(1, "Correct", SymptomsIronSuppLong$categories)
SymptomsIronSuppLong$categories <- as.factor(SymptomsIronSuppLong$categories)

SymptomsIronSuppLong$categories <- factor(SymptomsIronSuppLong$categories, levels=c('Incorrect','Correct'))
SymptomsIronSuppLong$type <- factor(SymptomsIronSuppLong$type, levels=c('Headache','Gastrointestinal complaints','Dark stool','Fatigue','Restless legs syndrome'))

# Proportions table
proportion_table <- SymptomsIronSuppLong %>%
  group_by(type) %>%
  summarise(
    Correct = sum(categories == "Correct"),
    Proportion = sum(categories == "Correct") / n()
  )
print(proportion_table)

# Plot outcomes
ggplot(SymptomsIronSuppLong, aes(y = type, fill = categories)) +
  geom_bar(position = "stack") +
  theme(text = element_text(size = 15)) +
  geom_text(stat = "count", aes(label = after_stat(count)), position = position_stack(vjust = 0.6)) +
  scale_fill_brewer(palette = "Purples")+
  scale_y_discrete(labels = function(y) stringr::str_wrap(y, width = 60)) +
  theme(
    axis.text.y = element_text(angle = 0, hjust = 1, size = 8),
    axis.text.x.bottom = element_text(size = 8),
    axis.title.x = element_text(vjust = -2, size = 14),
    legend.text = element_text(size = 12)
  ) + ylab("") + xlab("Frequency") + guides(fill = guide_legend(title = " ")) +
  theme_classic()+
  theme(legend.position = "bottom") 

FileName <- paste(FolderName, "/Knowledge Symptoms Iron Supplementation (Count).png",sep="")
ggsave(FileName, width = 12, height = 5)




# proportions
SymptomsIronSuppFig <- SymptomsIronSuppLong %>%
  group_by(type, categories) %>%
  summarise(total_count = n())

# Calculate proportions
SymptomsIronSuppFig <- SymptomsIronSuppFig %>%
  group_by(type) %>% 
  mutate(proportion = total_count / sum(total_count))

SymptomsIronSuppFig <- SymptomsIronSuppFig %>% ungroup()

# Plot the stacked bar plot with proportions
ggplot(SymptomsIronSuppFig, aes(y = reorder(type, -as.numeric(type)), fill = categories)) +
  geom_bar(position = "stack", aes(weight = proportion)) +
  theme_classic() +  # Set the overall theme
  theme(
    text = element_text(size = 15),
    plot.background = element_rect(fill = "white"),  # Set the background color to white
    axis.text.y = element_text(angle = 0, hjust = 1, size = 8),
    axis.text.x.bottom = element_text(size = 8),
    axis.title.x = element_text(vjust = -2, size = 14),
    legend.text = element_text(size = 12),
    legend.position = "bottom"
  ) +
  scale_fill_brewer(palette = "Purples") +
  scale_y_discrete(labels = function(y) stringr::str_wrap(y, width = 60)) +
  ylab("") +
  xlab("Proportion") +
  guides(fill = guide_legend(title = " ", reverse = TRUE))


FileName <- paste(FolderName, "/Knowledge Symptoms Iron Supplementation (Proportion).png",sep="")
ggsave(FileName, width = 10, height = 4)
```


## Missing Knowledge Sum-scores and Spread Knowledge 

```{r}
KnowledgeSpread <- Data[,c(4, 196:199)]

# Check for missings (31 max is <10%)
colSums(is.na(KnowledgeSpread))
# Missing data patterns
  #md.pattern(KnowledgeSpread)
# Remove NA
KnowledgeSpread <- KnowledgeSpread %>% drop_na()
# Create long dataset
Knowledege_long <- tidyr::gather(KnowledgeSpread, key = type_col, value = categories, -Sex)


ggplot(Knowledege_long, aes(categories,type_col)) + geom_jitter() +
    scale_x_continuous(breaks = round(seq(min(Knowledege_long$categories), max(Knowledege_long$categories), by = 0.5),1)) +
  xlab("Sum-score") + ylab("")

FileName <- paste(FolderName, "/Spread knowledge (non-scaled).png",sep="")
ggsave(FileName, width = 7, height = 4)

# Factor outcomes 
FactorSpread <- Data[,c(4, 188:190)]

Factor_long <- tidyr::gather(FactorSpread, key = type_col, value = categories, -Sex)


ggplot(Factor_long, aes(categories,type_col)) + geom_jitter() +
    scale_x_continuous(breaks = round(seq(min(Factor_long$categories), max(Factor_long$categories), by = 0.5),1)) +
  xlab("Factor Sum-scores") + ylab("") 

FileName <- paste(FolderName, "/Spread Factor Sum-scores.png",sep="")
ggsave(FileName, width = 7, height = 4)

```


# Box Plot Perception Domain
```{r}
#Bar-plot Factor Sum-Score per sex
data_long3$categories <- as.numeric(data_long3$categories)
Box_Perception <-ddply(data_long3, .(type_col), summarise,
         mean = mean(categories),
         sd = sd(categories),
         min = min(categories),
         max = max(categories))
Box_Perception
 
Box_Perception$Domain <- NA
Box_Perception <- Box_Perception %>% 
  mutate(
    Domain = case_when(
      type_col %in% c(
        "I would have a positive attitude towards this", 
        "I would gladly make use of this", 
        "I would prefer this over deferral"
      ) ~ "Willingness",
      type_col %in% c(
        "I think it is important that a physician is involved", 
        "I think it is important that my iron levels are monitored more often", 
        "I would like to receive more information about this first"
      ) ~ "Conditions",
      type_col %in% c(
        "I think too much is being asked of donors", 
        "I would find this pushy", 
        "This would have a negative effect on my motivation to donate"
      ) ~ "Invasiveness",
      TRUE ~ Domain
    )
  )

Box_Perception$Domain <- factor(Box_Perception$Domain, levels = c("Willingness", "Conditions", "Invasiveness"))
Box_Perception <- Box_Perception %>% arrange(Domain)

desired_order <- c(
  "I would have a positive attitude towards this",
  "I would gladly make use of this",
  "I would prefer this over deferral",
  "I think it is important that a physician is involved",
  "I think it is important that my iron levels are monitored more often",
  "I would like to receive more information about this first",
  "I think too much is being asked of donors",
  "I would find this pushy",
  "This would have a negative effect on my motivation to donate"
)
Box_Perception$type_col <- factor(Box_Perception$type_col, levels = desired_order)

Box_Perception$Domain <- factor(Box_Perception$Domain, levels=c('Willingness','Invasiveness', 'Conditions'))

ggplot(Box_Perception, aes(x = str_wrap(type_col, width = 15), color = Domain, group = Domain)) +
  geom_pointrange(position = position_dodge(width = 0.2), aes(ymin = mean - sd, y = mean, ymax = mean + sd), stat = "identity") +
  xlab("") +
  ylab("Likert-score") +
  coord_cartesian(ylim = c(0, 5)) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10, vjust = 1),
    axis.title.y = element_text(size = rel(0.8), angle = 90)
  ) +
  scale_y_continuous(breaks = seq(1, 5, by = 1)) + 
  scale_color_manual(values=c("#69b3a2", "darkred", "darkblue")) +
  theme_classic() +
  facet_grid(. ~ Domain, scales = "free_x", space = "free_x")+
  theme(legend.position = "none")

FileName <- paste(FolderName, "/Box-plot perception domains.png",sep="")
ggsave(FileName, width = 11, height = 6)

```

# Point-plot Perception sum scores

```{r}
## Preparation
SUM_Factor <- Data[,c(4, 188:190)]

# Rename Factor Sum-Score
names(SUM_Factor)[names(SUM_Factor) == "FA1_Positive"] <- "Willingness" # Gladly make use of, Positive towards iron suppl., Preferred over deferral
names(SUM_Factor)[names(SUM_Factor) == "FA2_Intrusive"] <- "Invasiveness" #Pushy, To much to ask, Negatively influenced donor motivation
names(SUM_Factor)[names(SUM_Factor) == "FA3_Conditions"] <- "Conditions" #

colSums(is.na(SUM_Factor)) # 

## Drop rows with missings
SUM_Factor <- SUM_Factor %>% drop_na()

## Bar-plot means per reason
MeltFactor <- melt(SUM_Factor)



#Bar-plot Factor Sum-Score per sex
data.sum1B <-ddply(MeltFactor, .(variable, Sex), summarise,
         mean = mean(value),
         sd = sd(value),
         min = min(value),
         max = max(value))
 
data.sum1B$variable <- factor(data.sum1B$variable, levels=c('Willingness','Invasiveness', 'Conditions'))

ggplot(data.sum1B, aes(x=reorder(variable, mean), color = Sex))+geom_pointrange(position = position_dodge(width = 0.2), aes(ymin = mean-sd, y = mean, ymax = mean+sd), stat="identity") + xlab("") + ylab("Sum score") + coord_cartesian(ylim=c(3, 15))+
        theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10)) + theme(axis.title.y = element_text(size = rel(0.8), angle = 90))+ scale_y_continuous(breaks = seq(3,15, by = 1)) +
  theme_classic() 

FileName <- paste(FolderName, "/Bargraph Factor Sum-Score per sex.png",sep="")
ggsave(FileName, width = 7, height = 4)



#Bar-plot Factor Sum-Score
data.sum1 <-ddply(MeltFactor, .(variable), summarise,
         mean = mean(value),
         sd = sd(value),
         min = min(value),
         max = max(value))
 
ggplot(data.sum1, aes(x=variable, color = variable))+geom_pointrange(position = position_dodge(width = 0.2), show.legend = FALSE, aes(ymin = mean-sd, y = mean, ymax = mean+sd), stat="identity") +
  xlab("") + ylab("Sum score") + coord_cartesian(ylim=c(3, 15))+
        theme(axis.text.x = element_text(angle = 45, hjust = 1)) + theme(axis.title.y = element_text(size = rel(0.8), angle = 90))+ scale_y_continuous(breaks = seq(3,15, by = 1))+
  theme_classic() + 
  scale_color_manual(values=c("#69b3a2", "darkred", "darkblue"))

FileName <- paste(FolderName, "/Bargraph Factor Sum-Score.png",sep="")
ggsave(FileName, width = 7, height = 4)
```


# Point-plot Knowledge Sum-Score

```{r}
## Preparation
KnowledgeLevel <- Data[,c(4, 197:199)]

# Scale knowledge variables 0 - 10
KnowledgeLevel$KnowledgeIronSupplements <- scales::rescale(KnowledgeLevel$KnowledgeIronSupplements, to=c(0,10))
KnowledgeLevel$KnowledgeIronMetabolism <- scales::rescale(KnowledgeLevel$KnowledgeIronMetabolism, to=c(0,10))
KnowledgeLevel$KnowledgePolicy <- scales::rescale(KnowledgeLevel$KnowledgePolicy, to=c(0,10))
KnowledgeLevel$KnowledgeDonation <- scales::rescale(KnowledgeLevel$KnowledgeDonation, to=c(0,10))

# Rename Factor Sum-Score
names(KnowledgeLevel)[names(KnowledgeLevel) == "KnowledgePolicy"] <- "Knowledge of current iron management policies" 
names(KnowledgeLevel)[names(KnowledgeLevel) == "KnowledgeIronMetabolism"] <- "Knowledge of iron metabolism" 
names(KnowledgeLevel)[names(KnowledgeLevel) == "KnowledgeIronSupplements"] <- "Knowledge of iron supplements" 

## Drop rows with missings
colSums(is.na(KnowledgeLevel)) # 16 missings
KnowledgeLevel <- KnowledgeLevel %>% drop_na()

## Bar-plot means per reason ##
MeltFactor2 <- melt(KnowledgeLevel)


#Bar-plot Sumscore
data.sum2 <-ddply(MeltFactor2, .(variable, Sex), summarise,
         mean = mean(value),
         sd = sd(value),
         min = min(value),
         max = max(value))
data.sum2

# Grouped by sex
ggplot(data.sum2, aes(x=reorder(variable, mean), color = Sex))+geom_pointrange(position = position_dodge(width = 0.2), width = 1, aes(ymin = mean-sd, y = mean, ymax = mean+sd), stat="identity") +
  xlab("") + ylab("Scaled sum scores") +
    scale_fill_brewer(palette="BuPu") + coord_cartesian(ylim=c(0, 10))+
        theme(axis.text.x = element_text(angle = 45, hjust = 1)) + theme(axis.title.y = element_text(size = rel(0.8), angle = 90))+ scale_y_continuous(breaks = seq(0,15, by = 1))+
  theme_classic() 

FileName <- paste(FolderName, "/Bargraph Knowledge level sex.png",sep="")
ggsave(FileName, width = 7, height = 4)

#Bar-plot Sumscore
data.sum2 <-ddply(MeltFactor2, .(variable), summarise,
         mean = mean(value),
         sd = sd(value),
         min = min(value),
         max = max(value))
data.sum2
 
ggplot(data.sum2, aes(x = variable, y = mean, color = variable)) +
  geom_pointrange(position = position_dodge(width = 0.2), show.legend = FALSE, width = 1, aes(ymin = mean - sd, y = mean, ymax = mean + sd), stat = "identity")  + 
  scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 22)) +
  theme_classic() +
  scale_color_manual(values = c("darkblue", "darkblue", "darkblue")) +
  scale_fill_brewer(palette = "BuPu") +
  coord_cartesian(ylim = c(0, 10)) +
  theme(axis.text.x = element_text(), axis.title.y = element_text(size = rel(0.8), angle = 90)) +
  scale_y_continuous(breaks = seq(0, 10, by = 1)) +
  ylab("Knowledge level (scaled sum score)") +
  xlab(" ")


FileName <- paste(FolderName, "/Bargraph Knowledge level.png",sep="")
ggsave(FileName, width = 6, height = 4)


```